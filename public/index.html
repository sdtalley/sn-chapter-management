<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SN Chapter Management</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- UNAUTHORIZED ACCESS MESSAGE -->
        <div id="unauthorized" class="unauthorized" style="display: none;">
            <h2>Unauthorized Access</h2>
            <p>You do not have permission to access this application.</p>
            <p>Please contact your administrator for access.</p>
        </div>

        <!-- MAIN MENU (Visible by default) -->
        <div id="main-menu" class="main-menu">
            <h2>Chapter Management</h2>
            <div class="nav-buttons">
                <button class="nav-btn" id="btn-verify-candidates" onclick="showPage('verify-candidates')">Verify Candidates</button>
                <button class="nav-btn" id="btn-verify-initiates" onclick="showPage('verify-initiates')">Verify Initiates</button>
                <button class="nav-btn" id="btn-roster-info" onclick="showPage('roster-info')">Roster Information</button>
                <button class="nav-btn" id="btn-officer-info" onclick="showPage('officer-info')">Officer Information</button>
                <button class="nav-btn" id="btn-contact-info" onclick="showPage('contact-info')">Chapter Contact Information</button>
                <button class="nav-btn" id="btn-fee-status" onclick="showPage('fee-status')">Fee Status</button>
                <button class="nav-btn" id="btn-admin" onclick="showPage('admin')">Admin</button>
            </div>
        </div>

        <!-- VERIFY CANDIDATES PAGE -->
        <div id="verify-candidates" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Verify Candidates</h2>
            
            <div class="loading-message" id="candidates-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading prospective candidates...</p>
            </div>
            
            <div id="candidates-content" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="candidates-chapter">-</span></p>
                    <p><strong>Total Prospective Candidates:</strong> <span id="candidates-count">0</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="candidates-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Approve</th>
                                <th>Candidate Ceremony Date</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="reviewCandidateChanges()">Review Changes</button>
                </div>
            </div>
            
            <!-- CANDIDATES REVIEW SECTION -->
            <div id="candidates-review" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="candidates-review-chapter">-</span></p>
                    <p><strong>Changes to Submit:</strong> <span id="candidates-review-count">0</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="candidates-review-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Approval Status</th>
                                <th>Candidate Ceremony Date</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-review-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="backToCandidates()">Back</button>
                    <button class="btn" onclick="submitCandidateVerifications()">Submit</button>
                </div>
            </div>
            
            <div id="candidates-error" class="error-message" style="display: none;">
                <p>Error loading candidates. Please try again or check your authentication.</p>
                <button class="btn" onclick="loadCandidates()">Retry</button>
            </div>
        </div>

        <!-- VERIFY INITIATES PAGE -->
        <div id="verify-initiates" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Verify Initiates</h2>
            
            <div class="loading-message" id="initiates-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading candidates...</p>
            </div>
            
            <div id="initiates-content" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="initiates-chapter">-</span></p>
                    <p><strong>Total Candidates:</strong> <span id="initiates-count">0</span></p>
                    <p id="last-badge-info" style="display: none;"><strong>The last badge assigned is <span id="last-badge-number">-</span>.</strong></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="initiates-table">
                        <thead>
                            <tr>
                                <th>Initiated</th>
                                <th>Name</th>
                                <th>Candidate Ceremony Date</th>
                                <th>Initiate Ceremony Date</th>
                                <th>Badge Number</th>
                            </tr>
                        </thead>
                        <tbody id="initiates-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="reviewInitiateChanges()">Review Changes</button>
                </div>
            </div>
            
            <!-- INITIATES REVIEW SECTION -->
            <div id="initiates-review" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="initiates-review-chapter">-</span></p>
                    <p><strong>Changes to Submit:</strong> <span id="initiates-review-count">0</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="initiates-review-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Initiate Ceremony Date</th>
                                <th>Badge Number</th>
                            </tr>
                        </thead>
                        <tbody id="initiates-review-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="backToInitiates()">Back</button>
                    <button class="btn" onclick="submitInitiateVerifications()">Submit</button>
                </div>
            </div>
            
            <div id="initiates-error" class="error-message" style="display: none;">
                <p>Error loading initiates. Please try again or check your authentication.</p>
                <button class="btn" onclick="loadInitiates()">Retry</button>
            </div>
        </div>

        <!-- ROSTER INFORMATION PAGE -->
        <div id="roster-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Roster Information</h2>
            
            <div class="loading-message" id="roster-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading roster information...</p>
            </div>
            
            <div id="roster-content" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="roster-chapter">-</span></p>
                    <p><strong>Total Candidates:</strong> <span id="roster-candidates-count">0</span></p>
                    <p><strong>Total Initiates:</strong> <span id="roster-initiates-count">0</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="roster-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Current</th>
                                <th>From Date</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="roster-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="reviewRosterChanges()">Review Changes</button>
                </div>
            </div>
            
            <!-- ROSTER REVIEW SECTION -->
            <div id="roster-review" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="roster-review-chapter">-</span></p>
                    <p><strong>Changes to Submit:</strong> <span id="roster-review-count">0</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="roster-review-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Current Status</th>
                                <th>New Status</th>
                                <th>Effective Date</th>
                            </tr>
                        </thead>
                        <tbody id="roster-review-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="backToRoster()">Back</button>
                    <button class="btn" onclick="submitRosterChanges()">Submit</button>
                </div>
            </div>
            
            <div id="roster-error" class="error-message" style="display: none;">
                <p>Error loading roster. Please try again or check your authentication.</p>
                <button class="btn" onclick="loadRoster()">Retry</button>
            </div>
        </div>

        <!-- OFFICER INFORMATION PAGE -->
        <div id="officer-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Officer Information</h2>
            
            <div class="loading-message" id="officer-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading officer information...</p>
            </div>
            
            <div id="officer-content" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="officer-chapter">-</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="officer-table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Current Officer</th>
                                <th>From Date</th>
                                <th>New Officer</th>
                                <th>Start Date</th>
                            </tr>
                        </thead>
                        <tbody id="officer-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="reviewOfficerChanges()">Review Changes</button>
                </div>
            </div>
            
            <!-- OFFICER REVIEW SECTION -->
            <div id="officer-review" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="officer-review-chapter">-</span></p>
                    <p><strong>Changes to Submit:</strong> <span id="officer-review-count">0</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="officer-review-table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Current Officer</th>
                                <th>New Officer</th>
                                <th>Start Date</th>
                            </tr>
                        </thead>
                        <tbody id="officer-review-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="backToOfficers()">Back</button>
                    <button class="btn" onclick="submitOfficerChanges()">Submit</button>
                </div>
            </div>
            
            <div id="officer-error" class="error-message" style="display: none;">
                <p>Error loading officers. Please try again or check your authentication.</p>
                <button class="btn" onclick="loadOfficers()">Retry</button>
            </div>
        </div>

        <!-- CHAPTER CONTACT INFORMATION PAGE -->
        <div id="contact-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Chapter Contact Information</h2>
            
            <div class="loading-message" id="contact-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading chapter contact information...</p>
            </div>
            
            <div id="contact-content" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="contact-chapter">-</span></p>
                </div>
                
                <div class="contact-form">
                    <h3>Postal Address</h3>
                    <div class="form-group">
                        <label for="postal-address-1">Address Line 1:</label>
                        <input type="text" id="postal-address-1" placeholder="Enter address line 1">
                    </div>
                    <div class="form-group">
                        <label for="postal-address-2">Address Line 2:</label>
                        <input type="text" id="postal-address-2" placeholder="Enter address line 2">
                    </div>
                    <div class="form-group">
                        <label for="postal-city">City:</label>
                        <input type="text" id="postal-city" placeholder="Enter city">
                    </div>
                    <div class="form-group">
                        <label for="postal-state">State:</label>
                        <input type="text" id="postal-state" placeholder="Enter state">
                    </div>
                    <div class="form-group">
                        <label for="postal-zip">Zip:</label>
                        <input type="text" id="postal-zip" placeholder="Enter zip code">
                    </div>
                    
                    <h3>Shipping Address</h3>
                    <div class="form-group">
                        <label for="shipping-address-1">Address Line 1:</label>
                        <input type="text" id="shipping-address-1" placeholder="Enter address line 1">
                    </div>
                    <div class="form-group">
                        <label for="shipping-address-2">Address Line 2:</label>
                        <input type="text" id="shipping-address-2" placeholder="Enter address line 2">
                    </div>
                    <div class="form-group">
                        <label for="shipping-city">City:</label>
                        <input type="text" id="shipping-city" placeholder="Enter city">
                    </div>
                    <div class="form-group">
                        <label for="shipping-state">State:</label>
                        <input type="text" id="shipping-state" placeholder="Enter state">
                    </div>
                    <div class="form-group">
                        <label for="shipping-zip">Zip:</label>
                        <input type="text" id="shipping-zip" placeholder="Enter zip code">
                    </div>
                    
                    <h3>Chapter Phone/Email</h3>
                    <div class="form-group">
                        <label for="chapter-phone">Chapter Phone:</label>
                        <input type="tel" id="chapter-phone" placeholder="(123) 456-7890">
                    </div>
                    <div class="form-group">
                        <label for="chapter-email">Chapter Email:</label>
                        <input type="email" id="chapter-email" placeholder="chapter@example.com">
                    </div>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="submitContactChanges()">Update Contact Information</button>
                </div>
            </div>
            
            <div id="contact-error" class="error-message" style="display: none;">
                <p>Error loading contact information. Please try again or check your authentication.</p>
                <button class="btn" onclick="loadContactInfo()">Retry</button>
            </div>
        </div>

        <!-- FEE STATUS PAGE -->
        <div id="fee-status" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Fee Status</h2>
            
            <div class="loading-message" id="fee-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading fee status information...</p>
            </div>
            
            <div id="fee-content" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="fee-chapter">-</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="fee-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Candidate Fee Paid</th>
                                <th>Initiate Fee Paid</th>
                            </tr>
                        </thead>
                        <tbody id="fee-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="fee-error" class="error-message" style="display: none;">
                <p>Error loading fee status. Please try again or check your authentication.</p>
                <button class="btn" onclick="loadFeeStatus()">Retry</button>
            </div>
        </div>

        <!-- ADMIN PAGE -->
        <div id="admin" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Admin & Testing</h2>
            
            <!-- Chapter Information Display -->
            <div class="url-params">
                <h3>Chapter Information</h3>
                <p><strong>SID:</strong> <span id="sid">Not provided</span></p>
                <p><strong>Chapter:</strong> <span id="chapter">Not provided</span></p>
                <p><strong>Officer Name:</strong> <span id="offname">Not provided</span></p>
            </div>
            
            <!-- Allow Skips Configuration -->
            <div class="allow-skips-section">
                <h3>Badge Skip Configuration</h3>
                
                <div class="loading-message" id="allow-skips-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading configuration...</p>
                </div>
                
                <div id="allow-skips-content" style="display: none;">
                    <div class="allow-skips-control">
                        <label class="checkbox-label">
                            <input type="checkbox" id="allow-skips-checkbox" class="allow-skip-checkbox">
                            <span>Allow badge number skips for <strong id="current-chapter-name">this chapter</strong></span>
                        </label>
                        <p class="help-text">When enabled, initiates can be assigned non-consecutive badge numbers.</p>
                    </div>
                </div>
                
                <div id="allow-skips-error" class="error-message" style="display: none;">
                    <p>Error loading configuration. Please try again.</p>
                    <button class="btn" onclick="loadAllowSkipsConfig()">Retry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules -->
    <script src="js/utils.js"></script>
    <script src="js/main.js"></script>
    <script src="js/api.js"></script>
    <script src="js/queries.js"></script>
    <script src="js/candidates.js"></script>
    
    <script>
        // Configuration
        const CONFIG = window.CONFIG; // Now comes from main.js
        
        // Use the global appState from main.js
        const appState = window.appState;

        // INITIATES FUNCTIONALITY
        async function loadInitiates() {
            console.log('=== loadInitiates() started ===');
            console.log('Chapter:', appState.chapter);
            
            if (!appState.chapter) {
                Utils.showError('initiates-error', 'No chapter specified. Please access this page with a chapter parameter.');
                console.error('No chapter parameter found');
                return;
            }

            // Show loading state
            console.log('Showing loading state...');
            Utils.showLoading('initiates-loading');
            Utils.hideElement('initiates-content');
            Utils.hideElement('initiates-error');

            try {
                // Check if skips are allowed for this chapter
                const skipValidationDisabled = await API.checkAllowedSkips();
                
                // Get full chapter data (includes both quid and memcatid)
                console.log('Getting chapter data for:', appState.chapter);
                const chapterData = await API.getChapterData(appState.chapter);
                console.log('Chapter data retrieved:', chapterData);
                
                if (!chapterData || !chapterData.quid) {
                    throw new Error(`Chapter data not found for ${appState.chapter}`);
                }

                // Execute both queries in parallel
                const [initiatesResults, topBadgeResults] = await Promise.all([
                    // Query 1: Get initiates
                    API.executeQuery(Queries.buildInitiatesQuery(chapterData.quid, appState.chapter), 'candidates'),
                    // Query 2: Get top badge (only if memcatid exists)
                    chapterData.memcatid ? API.executeQuery(Queries.buildTopBadgeQuery(chapterData.memcatid), 'topbadge') : Promise.resolve(null)
                ]);
                
                // Process initiates results
                const initiates = processInitiatesResults(initiatesResults);
                console.log('Processed initiates:', initiates);
                
                // Process top badge if available
                let topBadgeNumber = null;
                if (topBadgeResults && Array.isArray(topBadgeResults) && topBadgeResults.length > 0) {
                    const fullBadge = topBadgeResults[0].Badge;
                    // Extract last 4 characters and convert to number to remove leading zeros
                    const last4 = fullBadge.slice(-4);
                    topBadgeNumber = parseInt(last4, 10);
                    console.log('Top badge found:', fullBadge, '-> processed to:', topBadgeNumber);
                }
                
                // Store in app state for validation
                appState.lastBadgeNumber = topBadgeNumber;
                appState.skipValidationDisabled = skipValidationDisabled;
                
                // Display initiates with top badge info
                displayInitiates(initiates, topBadgeNumber);
                
            } catch (error) {
                console.error('Error loading initiates:', error);
                Utils.showError('initiates-error', `Failed to load initiates: ${error.message}`);
            }
        }

        function processInitiatesResults(results) {
            console.log('=== processInitiatesResults() started ===');
            console.log('Raw results:', results);
            
            const initiates = [];
            
            if (Array.isArray(results)) {
                console.log(`Processing ${results.length} initiates`);
                
                results.forEach((row, index) => {
                    console.log(`Row ${index}:`, row);
                    
                    // Truncate codeId to last 5 digits
                    let truncatedCodeId = row.CodeID || '';
                    if (truncatedCodeId && truncatedCodeId.length > 5) {
                        truncatedCodeId = truncatedCodeId.slice(-5);
                    }
                    
                    // Truncate relationId to last 7 digits
                    let truncatedRelationId = row.Relation_ID || '';
                    if (truncatedRelationId && truncatedRelationId.length > 7) {
                        truncatedRelationId = truncatedRelationId.slice(-7);
                    }
                    
                    const initiate = {
                        id: row.ID || row.QRECID || row.id,
                        name: row.Name || row.name || 'N/A',
                        candidateCeremonyDate: row.Candidate_Ceremony_Date || '',
                        code: row.Code || '',
                        codeId: truncatedCodeId,
                        relationId: truncatedRelationId
                    };
                    
                    console.log(`Initiate ${index}:`, initiate);
                    initiates.push(initiate);
                });
            } else {
                console.warn('Unexpected results format:', results);
            }

            console.log(`Total initiates processed: ${initiates.length}`);
            return initiates;
        }

        function displayInitiates(initiates, topBadgeNumber = null) {
            console.log('=== displayInitiates() started ===');
            console.log('Number of initiates to display:', initiates.length);
            console.log('Top badge number:', topBadgeNumber);
            
            const chapterSpan = document.getElementById('initiates-chapter');
            const countSpan = document.getElementById('initiates-count');
            const tbody = document.getElementById('initiates-tbody');
            const lastBadgeInfo = document.getElementById('last-badge-info');
            const lastBadgeNumber = document.getElementById('last-badge-number');
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            if (countSpan) countSpan.textContent = initiates.length;
            
            // Display top badge if available
            if (topBadgeNumber !== null && lastBadgeInfo && lastBadgeNumber) {
                lastBadgeNumber.textContent = topBadgeNumber.toString();
                lastBadgeInfo.style.display = 'block';
            }
            
            // Clear existing rows
            if (tbody) {
                tbody.innerHTML = '';
                
                if (initiates.length === 0) {
                    console.log('No initiates found - showing empty state');
                    const row = tbody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 5; // 5 columns for initiates table
                    cell.className = 'empty-state-cell';
                    cell.textContent = 'No prospective initiates found for this chapter.';
                } else {
                    console.log('Creating table rows for initiates...');
                    initiates.forEach((initiate, index) => {
                        console.log(`Creating row ${index} for:`, initiate);
                        
                        const row = tbody.insertRow();
                        
                        // Store initiate ID, code, codeId, and relationId as data attributes
                        row.dataset.initiateId = initiate.id;
                        row.dataset.code = initiate.code;
                        row.dataset.codeId = initiate.codeId;
                        row.dataset.relationId = initiate.relationId;
                        
                        // Initiated checkbox
                        const initiatedCell = row.insertCell();
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'initiated-checkbox';
                        checkbox.id = `initiated-${index}`;
                        checkbox.addEventListener('change', function() {
                            handleInitiatedChange(index, this.checked);
                        });
                        initiatedCell.appendChild(checkbox);
                        
                        // Name
                        const nameCell = row.insertCell();
                        nameCell.textContent = initiate.name || 'N/A';
                        
                        // Candidate Ceremony Date
                        const candidateDateCell = row.insertCell();
                        if (initiate.candidateCeremonyDate) {
                            // Format date for display if it exists
                            candidateDateCell.textContent = Utils.formatDateForDisplay(initiate.candidateCeremonyDate);
                        } else {
                            candidateDateCell.textContent = 'N/A';
                        }
                        
                        // Initiate Ceremony Date
                        const initiateDateCell = row.insertCell();
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.className = 'date-input';
                        dateInput.id = `initiate-ceremony-date-${index}`;
                        dateInput.disabled = true; // Initially disabled
                        
                        // Set max date to today
                        const today = new Date();
                        dateInput.max = today.toISOString().split('T')[0];
                        
                        // Set min date to day after candidate ceremony date if it exists
                        if (initiate.candidateCeremonyDate) {
                            const candidateDate = Utils.parseDate(initiate.candidateCeremonyDate);
                            if (candidateDate) {
                                candidateDate.setDate(candidateDate.getDate() + 1);
                                dateInput.min = candidateDate.toISOString().split('T')[0];
                            }
                        }
                        
                        initiateDateCell.appendChild(dateInput);
                        
                        // Badge Number
                        const badgeCell = row.insertCell();
                        const badgeInput = document.createElement('input');
                        badgeInput.type = 'number';
                        badgeInput.className = 'badge-input';
                        badgeInput.id = `badge-number-${index}`;
                        badgeInput.disabled = true; // Initially disabled
                        
                        // Set min based on last badge number
                        if (topBadgeNumber !== null) {
                            badgeInput.min = (topBadgeNumber + 1).toString();
                        } else {
                            badgeInput.min = '1';
                        }
                        badgeInput.max = '9999';
                        badgeInput.placeholder = '0000';
                        
                        // Add validation for badge number
                        badgeInput.addEventListener('input', function() {
                            // Restrict to 4 digits
                            if (this.value.length > 4) {
                                this.value = this.value.slice(0, 4);
                            }
                            
                            // Validate against last badge number
                            if (appState.lastBadgeNumber !== null && this.value) {
                                const enteredNumber = parseInt(this.value, 10);
                                if (enteredNumber <= appState.lastBadgeNumber) {
                                    this.setCustomValidity(`Badge number must be greater than ${appState.lastBadgeNumber}`);
                                    this.reportValidity();
                                } else {
                                    this.setCustomValidity('');
                                }
                            }
                        });
                        
                        badgeCell.appendChild(badgeInput);
                    });
                }
            }
            
            // Show content
            console.log('Hiding loading state and showing content...');
            Utils.hideElement('initiates-loading');
            Utils.showElement('initiates-content');
            
            // Trigger resize
            Utils.resizeIframe();
            console.log('=== displayInitiates() completed ===');
        }

        function handleInitiatedChange(index, isChecked) {
            const dateInput = document.getElementById(`initiate-ceremony-date-${index}`);
            const badgeInput = document.getElementById(`badge-number-${index}`);
            
            if (dateInput) {
                dateInput.disabled = !isChecked;
                if (!isChecked) {
                    dateInput.value = '';
                }
            }
            
            if (badgeInput) {
                badgeInput.disabled = !isChecked;
                if (!isChecked) {
                    badgeInput.value = '';
                }
            }
        }

        function submitInitiateVerifications() {
            // Get all initiate data
            const initiates = [];
            const tbody = document.getElementById('initiates-tbody');
            
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach((row, index) => {
                    const initiateId = row.dataset.initiateId;
                    if (initiateId) {
                        const checkbox = document.getElementById(`initiated-${index}`);
                        const dateInput = document.getElementById(`initiate-ceremony-date-${index}`);
                        const badgeInput = document.getElementById(`badge-number-${index}`);
                        
                        if (checkbox && checkbox.checked && dateInput && badgeInput) {
                            // Format date as mm/dd/yyyy for display
                            let formattedDate = '';
                            if (dateInput.value) {
                                const [year, month, day] = dateInput.value.split('-');
                                formattedDate = `${month}/${day}/${year}`;
                            }
                            
                            initiates.push({
                                id: initiateId,
                                initiated: true,
                                ceremonyDate: dateInput.value,
                                ceremonyDateFormatted: formattedDate,
                                badgeNumber: badgeInput.value
                            });
                        }
                    }
                });
            }
            
            if (initiates.length === 0) {
                Utils.showStatus('No initiates have been selected. Please check at least one initiate.', 'error');
                return;
            }
            
            // Validate that all selected initiates have ceremony dates and badge numbers
            const incomplete = initiates.filter(i => !i.ceremonyDate || !i.badgeNumber);
            
            if (incomplete.length > 0) {
                Utils.showStatus(`Please ensure all selected initiates have ceremony dates and badge numbers. ${incomplete.length} initiate(s) missing required information.`, 'error');
                return;
            }
            
            // Validate badge numbers are greater than last badge
            if (appState.lastBadgeNumber !== null) {
                const invalidBadges = initiates.filter(i => {
                    const badgeNum = parseInt(i.badgeNumber, 10);
                    return badgeNum <= appState.lastBadgeNumber;
                });
                
                if (invalidBadges.length > 0) {
                    Utils.showStatus(`Badge numbers must be greater than ${appState.lastBadgeNumber}. ${invalidBadges.length} initiate(s) have invalid badge numbers.`, 'error');
                    return;
                }
            }
            
            // For now, just show what would be submitted
            console.log('Initiate verifications to submit:', initiates);
            Utils.showStatus(`Ready to submit ${initiates.length} initiate verification(s). (Submit functionality coming soon)`, 'info');
        }
        
        async function getRosterInfo() {
            const rosterType = document.getElementById('rosterType').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            // Add filtering based on roster type and chapter info
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}`;
            }
            
            await API.makeApiCall(endpoint, 'rosterResult');
        }
        
        // ROSTER FUNCTIONALITY
        async function loadRoster() {
            console.log('=== loadRoster() started ===');
            console.log('Chapter:', appState.chapter);
            
            if (!appState.chapter) {
                Utils.showRosterError('No chapter specified. Please access this page with a chapter parameter.');
                console.error('No chapter parameter found');
                return;
            }

            // Show loading state
            console.log('Showing loading state...');
            Utils.showLoading('roster-loading');
            Utils.hideElement('roster-content');
            Utils.hideElement('roster-error');

            try {
                // Get chapter QUID
                console.log('Getting chapter QUID for:', appState.chapter);
                const chapterQuid = await API.getChapterQuid(appState.chapter);
                console.log('Chapter QUID retrieved:', chapterQuid);
                
                if (!chapterQuid) {
                    throw new Error(`Chapter QUID not found for ${appState.chapter}`);
                }

                // Build and execute query
                const queryRequest = Queries.buildRosterQuery(chapterQuid, appState.chapter);
                const resultsData = await API.executeQuery(queryRequest, 'roster');
                
                // Process results
                const roster = processRosterResults(resultsData);
                console.log('Processed roster:', roster);
                
                // Display roster
                displayRoster(roster);
                
            } catch (error) {
                console.error('Error loading roster:', error);
                Utils.showRosterError(`Failed to load roster: ${error.message}`);
            }
        }

        function processRosterResults(results) {
            console.log('=== processRosterResults() started ===');
            console.log('Raw results:', results);
            
            const roster = [];
            
            if (Array.isArray(results)) {
                console.log(`Processing ${results.length} roster members`);
                
                results.forEach((row, index) => {
                    console.log(`Row ${index}:`, row);
                    
                    // Truncate codeId to last 5 digits
                    let truncatedCodeId = row.CodeID || '';
                    if (truncatedCodeId && truncatedCodeId.length > 5) {
                        truncatedCodeId = truncatedCodeId.slice(-5);
                    }
                    
                    // Truncate relationId to last 7 digits
                    let truncatedRelationId = row.Relation_ID || '';
                    if (truncatedRelationId && truncatedRelationId.length > 7) {
                        truncatedRelationId = truncatedRelationId.slice(-7);
                    }
                    
                    const member = {
                        id: row.ID || row.QRECID || row.id,
                        name: row.Name || row.name || 'N/A',
                        status: row.Code || row.Status || 'Unknown',
                        fromDate: row.From_Date || '',
                        relationId: truncatedRelationId,
                        candidateFeePaid: row.Candidate_Fee_Paid || 'No',
                        initiateFeePaid: row.Initiate_Fee_Paid || 'No',
                        codeId: truncatedCodeId
                    };
                    
                    console.log(`Member ${index}:`, member);
                    roster.push(member);
                });
            } else {
                console.warn('Unexpected results format:', results);
            }

            console.log(`Total roster members processed: ${roster.length}`);
            return roster;
        }

        function displayRoster(roster) {
            console.log('=== displayRoster() started ===');
            console.log('Number of members to display:', roster.length);
            
            const chapterSpan = document.getElementById('roster-chapter');
            const candidatesCountSpan = document.getElementById('roster-candidates-count');
            const initiatesCountSpan = document.getElementById('roster-initiates-count');
            const tbody = document.getElementById('roster-tbody');
            
            // Count candidates and initiates
            let candidatesCount = 0;
            let initiatesCount = 0;
            roster.forEach(member => {
                if (member.status === '5707' || member.status === 'Candidate') {
                    candidatesCount++;
                } else if (member.status === '5708' || member.status === 'Initiate') {
                    initiatesCount++;
                }
            });
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            if (candidatesCountSpan) candidatesCountSpan.textContent = candidatesCount;
            if (initiatesCountSpan) initiatesCountSpan.textContent = initiatesCount;
            
            // Clear existing rows
            if (tbody) {
                tbody.innerHTML = '';
                
                if (roster.length === 0) {
                    console.log('No members found - showing empty state');
                    const row = tbody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 5;
                    cell.className = 'empty-state-cell';
                    cell.textContent = 'No members found for this chapter.';
                } else {
                    console.log('Creating table rows for roster...');
                    roster.forEach((member, index) => {
                        console.log(`Creating row ${index} for:`, member);
                        
                        const row = tbody.insertRow();
                        
                        // Store member data as attributes
                        row.dataset.memberId = member.id;
                        row.dataset.memberStatus = member.status;
                        row.dataset.candidateFeePaid = member.candidateFeePaid;
                        row.dataset.initiateFeePaid = member.initiateFeePaid;
                        row.dataset.codeId = member.codeId;
                        row.dataset.relationId = member.relationId;
                        
                        // Name
                        const nameCell = row.insertCell();
                        nameCell.textContent = member.name || 'N/A';
                        
                        // Current Status
                        const currentCell = row.insertCell();
                        currentCell.textContent = member.status === '5707' || member.status === 'Candidate' ? 'Candidate' : 
                                                member.status === '5708' || member.status === 'Initiate' ? 'Initiate' : 
                                                member.status;
                        
                        // From Date
                        const fromDateCell = row.insertCell();
                        fromDateCell.textContent = Utils.formatDateForDisplay(member.fromDate);
                        
                        // Status dropdown
                        const statusCell = row.insertCell();
                        
                        // Determine if dropdown should be shown
                        const isCandidate = member.status === '5707' || member.status === 'Candidate';
                        const isInitiate = member.status === '5708' || member.status === 'Initiate';
                        const candidateFeeUnpaid = isCandidate && member.candidateFeePaid !== 'Yes';
                        const feesUnpaid = isInitiate && (member.candidateFeePaid !== 'Yes' || member.initiateFeePaid !== 'Yes');
                        
                        if (candidateFeeUnpaid) {
                            statusCell.textContent = '-';
                            statusCell.title = 'Candidate Fee Unpaid';
                            statusCell.style.cursor = 'help';
                        } else {
                            const selectWrapper = document.createElement('div');
                            selectWrapper.className = 'select-wrapper';
                            
                            const statusSelect = document.createElement('select');
                            statusSelect.className = 'status-select';
                            statusSelect.id = `status-${index}`;
                            
                            // Default option
                            const defaultOption = document.createElement('option');
                            defaultOption.value = '';
                            defaultOption.textContent = 'No Change';
                            defaultOption.selected = true;
                            statusSelect.appendChild(defaultOption);
                            
                            if (isCandidate) {
                                // Candidate options
                                const depledgeOption = document.createElement('option');
                                depledgeOption.value = 'De-Pledge';
                                depledgeOption.textContent = 'De-pledge';
                                statusSelect.appendChild(depledgeOption);
                            } else if (isInitiate) {
                                if (feesUnpaid) {
                                    // Limited options for unpaid fees
                                    selectWrapper.title = 'Fee(s) Unpaid';
                                    
                                    const suspendedOption = document.createElement('option');
                                    suspendedOption.value = 'Proposed Suspended';
                                    suspendedOption.textContent = 'Proposed Suspended';
                                    statusSelect.appendChild(suspendedOption);
                                    
                                    const expelledOption = document.createElement('option');
                                    expelledOption.value = 'Proposed Expelled';
                                    expelledOption.textContent = 'Proposed Expelled';
                                    statusSelect.appendChild(expelledOption);
                                } else {
                                    // Full options for paid fees
                                    const alumniLeftOption = document.createElement('option');
                                    alumniLeftOption.value = 'Alumni (Left School)';
                                    alumniLeftOption.textContent = 'Alumni (Left-School)';
                                    statusSelect.appendChild(alumniLeftOption);
                                    
                                    const alumniGradOption = document.createElement('option');
                                    alumniGradOption.value = 'Alumni';
                                    alumniGradOption.textContent = 'Alumni (Graduated)';
                                    statusSelect.appendChild(alumniGradOption);
                                    
                                    const suspendedOption = document.createElement('option');
                                    suspendedOption.value = 'Proposed Suspended';
                                    suspendedOption.textContent = 'Proposed Suspended';
                                    statusSelect.appendChild(suspendedOption);
                                    
                                    const expelledOption = document.createElement('option');
                                    expelledOption.value = 'Proposed Expelled';
                                    expelledOption.textContent = 'Proposed Expelled';
                                    statusSelect.appendChild(expelledOption);
                                }
                            }
                            
                            // Add change event listener
                            statusSelect.addEventListener('change', function() {
                                handleRosterStatusChange(index, this.value);
                            });
                            
                            selectWrapper.appendChild(statusSelect);
                            statusCell.appendChild(selectWrapper);
                        }
                        
                        // Date picker
                        const dateCell = row.insertCell();
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.className = 'date-input';
                        dateInput.id = `roster-date-${index}`;
                        dateInput.disabled = true; // Initially disabled
                        
                        // Set max date to today
                        const today = new Date();
                        dateInput.max = today.toISOString().split('T')[0];
                        
                        // Set min date to day after from date if it exists
                        if (member.fromDate) {
                            const fromDate = Utils.parseDate(member.fromDate);
                            if (fromDate) {
                                fromDate.setDate(fromDate.getDate() + 1);
                                dateInput.min = fromDate.toISOString().split('T')[0];
                            }
                        }
                        
                        dateCell.appendChild(dateInput);
                    });
                }
            }
            
            // Show content
            console.log('Hiding loading state and showing content...');
            Utils.hideElement('roster-loading');
            Utils.showElement('roster-content');
            
            // Trigger resize
            Utils.resizeIframe();
            console.log('=== displayRoster() completed ===');
        }

        function handleRosterStatusChange(index, statusValue) {
            const dateInput = document.getElementById(`roster-date-${index}`);
            if (!dateInput) return;

            if (statusValue && statusValue !== '') {
                // Enable date picker when status is selected
                dateInput.disabled = false;
                dateInput.value = ''; // Clear any default value
            } else {
                // Disable and clear date when "No Change" is selected
                dateInput.disabled = true;
                dateInput.value = '';
            }
        }

        function submitRosterChanges() {
            // For now, just show what would be submitted
            console.log('Roster changes to submit from review');
            Utils.showStatus('Submit functionality coming soon', 'info');
        }

        // ROSTER REVIEW FUNCTIONS
        function reviewRosterChanges() {
            // Get all roster changes
            const changes = [];
            const tbody = document.getElementById('roster-tbody');
            
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach((row, index) => {
                    const memberId = row.dataset.memberId;
                    if (memberId) {
                        const statusSelect = document.getElementById(`status-${index}`);
                        const dateInput = document.getElementById(`roster-date-${index}`);
                        const nameCell = row.cells[0];
                        const currentStatusCell = row.cells[1];
                        
                        if (statusSelect && statusSelect.value && statusSelect.value !== '' && dateInput) {
                            const selectedOption = statusSelect.options[statusSelect.selectedIndex];
                            
                            changes.push({
                                id: memberId,
                                name: nameCell.textContent,
                                currentStatus: currentStatusCell.textContent,
                                newStatus: statusSelect.value,
                                newStatusText: selectedOption.textContent,
                                effectiveDate: dateInput.value,
                                effectiveDateFormatted: dateInput.value ? Utils.formatDateForDisplay(dateInput.value) : '',
                                codeId: row.dataset.codeId,
                                relationId: row.dataset.relationId
                            });
                        }
                    }
                });
            }
            
            if (changes.length === 0) {
                const message = 'No changes have been made. Please select a status for at least one member.';
                alert(message);
                Utils.showStatus(message, 'error');
                return;
            }
            
            // Validate that all changes have dates
            const incomplete = changes.filter(c => !c.effectiveDate);
            
            if (incomplete.length > 0) {
                const message = `Please ensure all status changes have effective dates. ${incomplete.length} member(s) missing date.`;
                alert(message);
                Utils.showStatus(message, 'error');
                return;
            }
            
            // Display review table
            displayRosterReview(changes);
        }

        function displayRosterReview(changes) {
            const chapterSpan = document.getElementById('roster-review-chapter');
            const countSpan = document.getElementById('roster-review-count');
            const tbody = document.getElementById('roster-review-tbody');
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            if (countSpan) countSpan.textContent = changes.length;
            
            if (tbody) {
                tbody.innerHTML = '';
                
                changes.forEach(change => {
                    const row = tbody.insertRow();
                    
                    // Name
                    const nameCell = row.insertCell();
                    nameCell.textContent = change.name;
                    
                    // Current Status
                    const currentCell = row.insertCell();
                    currentCell.textContent = change.currentStatus;
                    
                    // New Status
                    const newStatusCell = row.insertCell();
                    newStatusCell.textContent = change.newStatusText;
                    
                    // Effective Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = change.effectiveDateFormatted;
                });
            }
            
            // Hide main content, show review
            Utils.hideElement('roster-content');
            Utils.showElement('roster-review');
            Utils.resizeIframe();
        }

        function backToRoster() {
            Utils.hideElement('roster-review');
            Utils.showElement('roster-content');
            Utils.resizeIframe();
        }
        
        async function getOfficerInfo() {
            const officerPosition = document.getElementById('officerPosition').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            // Add filtering for officers
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}&role=officer`;
            }
            
            await API.makeApiCall(endpoint, 'officerResult');
        }
        
        // OFFICER FUNCTIONALITY
        async function loadOfficers() {
            console.log('=== loadOfficers() started ===');
            console.log('Chapter:', appState.chapter);
            
            if (!appState.chapter) {
                Utils.showOfficerError('No chapter specified. Please access this page with a chapter parameter.');
                console.error('No chapter parameter found');
                return;
            }

            // Show loading state
            console.log('Showing loading state...');
            Utils.showLoading('officer-loading');
            Utils.hideElement('officer-content');
            Utils.hideElement('officer-error');

            try {
                // Get chapter QUID
                console.log('Getting chapter QUID for:', appState.chapter);
                const chapterQuid = await API.getChapterQuid(appState.chapter);
                console.log('Chapter QUID retrieved:', chapterQuid);
                
                if (!chapterQuid) {
                    throw new Error(`Chapter QUID not found for ${appState.chapter}`);
                }

                // Execute both queries in parallel
                const [rosterResults, officerResults] = await Promise.all([
                    // Query 1: Get roster for member list
                    API.executeQuery(Queries.buildRosterQuery(chapterQuid, appState.chapter), 'roster_for_officers'),
                    // Query 2: Get current officers
                    API.executeQuery(Queries.buildOfficerQuery(chapterQuid, appState.chapter), 'officers')
                ]);
                
                // Process results
                const roster = processRosterResults(rosterResults);
                const officers = processOfficerResults(officerResults);
                
                console.log('Processed roster:', roster);
                console.log('Processed officers:', officers);
                
                // Display officers
                displayOfficers(officers, roster);
                
            } catch (error) {
                console.error('Error loading officers:', error);
                Utils.showOfficerError(`Failed to load officers: ${error.message}`);
            }
        }

        function processOfficerResults(results) {
            console.log('=== processOfficerResults() started ===');
            console.log('Raw results:', results);
            
            const officers = [];
            
            if (Array.isArray(results)) {
                console.log(`Processing ${results.length} officers`);
                
                results.forEach((row, index) => {
                    console.log(`Row ${index}:`, row);
                    
                    // Truncate relationId to last 7 digits
                    let truncatedRelationId = row.Relation_ID || '';
                    if (truncatedRelationId && truncatedRelationId.length > 7) {
                        truncatedRelationId = truncatedRelationId.slice(-7);
                    }
                    
                    const officer = {
                        position: row.Position || 'Unknown',
                        id: row.ID || row.QRECID || row.id,
                        name: row.Name || row.name || 'N/A',
                        fromDate: row.From_Date || '',
                        relationId: truncatedRelationId,
                        orgImpId: row.Org_ImpID || ''
                    };
                    
                    console.log(`Officer ${index}:`, officer);
                    officers.push(officer);
                });
            } else {
                console.warn('Unexpected results format:', results);
            }

            console.log(`Total officers processed: ${officers.length}`);
            return officers;
        }

        // Define all 16 officer positions in order
        const OFFICER_POSITIONS = [
            'Alumni Relations',
            'Chaplain',
            'Commander',
            'House Manager',
            'LEAD Chairman',
            'Lt. Commander',
            'Marshal',
            'Philanthropy/Community Relations',
            'Recorder',
            'Recruitment Chairman',
            'Reporter',
            'Risk Reduction Officer',
            'Scholarship Chairman',
            'Sentinel',
            'Social Chairman',
            'Treasurer'
        ];

        function displayOfficers(officers, roster) {
            console.log('=== displayOfficers() started ===');
            console.log('Number of officers:', officers.length);
            console.log('Number of roster members:', roster.length);
            
            const chapterSpan = document.getElementById('officer-chapter');
            const tbody = document.getElementById('officer-tbody');
            
            // Process officers to handle duplicates - keep only the latest
            const officerMap = {};
            officers.forEach(officer => {
                const existingOfficer = officerMap[officer.position];
                if (!existingOfficer || Utils.compareFromDates(officer.fromDate, existingOfficer.fromDate) > 0) {
                    officerMap[officer.position] = officer;
                }
            });
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            
            // Clear existing rows
            if (tbody) {
                tbody.innerHTML = '';
                
                // Create rows for all 16 positions
                OFFICER_POSITIONS.forEach((position, index) => {
                    console.log(`Creating row for position: ${position}`);
                    
                    const row = tbody.insertRow();
                    const currentOfficer = officerMap[position];
                    
                    // Store position data
                    row.dataset.position = position;
                    if (currentOfficer) {
                        row.dataset.currentOfficerId = currentOfficer.id;
                        row.dataset.currentOfficerName = currentOfficer.name;
                        row.dataset.fromDate = currentOfficer.fromDate;
                        row.dataset.relationId = currentOfficer.relationId;
                    }
                    
                    // Position
                    const positionCell = row.insertCell();
                    positionCell.textContent = position;
                    
                    // Current Officer
                    const currentCell = row.insertCell();
                    currentCell.textContent = currentOfficer ? currentOfficer.name : '-';
                    
                    // From Date
                    const fromDateCell = row.insertCell();
                    fromDateCell.textContent = currentOfficer ? Utils.formatDateForDisplay(currentOfficer.fromDate) : '-';
                    
                    // New Officer dropdown
                    const newOfficerCell = row.insertCell();
                    const selectWrapper = document.createElement('div');
                    selectWrapper.className = 'select-wrapper';
                    
                    const officerSelect = document.createElement('select');
                    officerSelect.className = 'officer-select';
                    officerSelect.id = `new-officer-${index}`;
                    
                    // Default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'No Change';
                    defaultOption.selected = true;
                    officerSelect.appendChild(defaultOption);
                    
                    // Add all roster members as options
                    roster.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.name;
                        option.dataset.memberId = member.id;
                        officerSelect.appendChild(option);
                    });
                    
                    // Add change event listener
                    officerSelect.addEventListener('change', function() {
                        handleOfficerChange(index, this.value);
                    });
                    
                    selectWrapper.appendChild(officerSelect);
                    newOfficerCell.appendChild(selectWrapper);
                    
                    // Start Date picker
                    const startDateCell = row.insertCell();
                    const dateInput = document.createElement('input');
                    dateInput.type = 'date';
                    dateInput.className = 'date-input';
                    dateInput.id = `officer-start-date-${index}`;
                    dateInput.disabled = true; // Initially disabled
                    
                    // Set max date to today
                    const today = new Date();
                    dateInput.max = today.toISOString().split('T')[0];
                    
                    // Set min date to day after current officer's from date if exists
                    if (currentOfficer && currentOfficer.fromDate) {
                        const fromDate = Utils.parseDate(currentOfficer.fromDate);
                        if (fromDate) {
                            fromDate.setDate(fromDate.getDate() + 1);
                            dateInput.min = fromDate.toISOString().split('T')[0];
                        }
                    }
                    
                    startDateCell.appendChild(dateInput);
                });
            }
            
            // Show content
            console.log('Hiding loading state and showing content...');
            Utils.hideElement('officer-loading');
            Utils.showElement('officer-content');
            
            // Trigger resize
            Utils.resizeIframe();
            console.log('=== displayOfficers() completed ===');
        }

        function handleOfficerChange(index, newOfficerId) {
            const dateInput = document.getElementById(`officer-start-date-${index}`);
            if (!dateInput) return;

            if (newOfficerId && newOfficerId !== '') {
                // Enable date picker when officer is selected
                dateInput.disabled = false;
                dateInput.value = ''; // Clear any default value
            } else {
                // Disable and clear date when "No Change" is selected
                dateInput.disabled = true;
                dateInput.value = '';
            }
        }

        function submitOfficerChanges() {
            // For now, just show what would be submitted
            console.log('Officer changes to submit from review');
            Utils.showStatus('Submit functionality coming soon', 'info');
        }

        // OFFICER REVIEW FUNCTIONS
        function reviewOfficerChanges() {
            // Get all officer changes
            const changes = [];
            const tbody = document.getElementById('officer-tbody');
            
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach((row, index) => {
                    const position = row.dataset.position;
                    if (position) {
                        const officerSelect = document.getElementById(`new-officer-${index}`);
                        const dateInput = document.getElementById(`officer-start-date-${index}`);
                        const currentOfficerCell = row.cells[1];
                        
                        if (officerSelect && officerSelect.value && officerSelect.value !== '' && dateInput) {
                            const selectedOption = officerSelect.options[officerSelect.selectedIndex];
                            
                            changes.push({
                                position: position,
                                currentOfficer: currentOfficerCell.textContent === '-' ? 'None' : currentOfficerCell.textContent,
                                currentOfficerId: row.dataset.currentOfficerId || null,
                                newOfficerId: officerSelect.value,
                                newOfficerName: selectedOption.textContent,
                                startDate: dateInput.value,
                                startDateFormatted: dateInput.value ? Utils.formatDateForDisplay(dateInput.value) : '',
                                relationId: row.dataset.relationId || null
                            });
                        }
                    }
                });
            }
            
            if (changes.length === 0) {
                const message = 'No changes have been made. Please select a new officer for at least one position.';
                alert(message);
                Utils.showStatus(message, 'error');
                return;
            }
            
            // Validate that all changes have start dates
            const incomplete = changes.filter(c => !c.startDate);
            
            if (incomplete.length > 0) {
                const message = `Please ensure all officer changes have start dates. ${incomplete.length} position(s) missing date.`;
                alert(message);
                Utils.showStatus(message, 'error');
                return;
            }
            
            // Display review table
            displayOfficerReview(changes);
        }

        function displayOfficerReview(changes) {
            const chapterSpan = document.getElementById('officer-review-chapter');
            const countSpan = document.getElementById('officer-review-count');
            const tbody = document.getElementById('officer-review-tbody');
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            if (countSpan) countSpan.textContent = changes.length;
            
            if (tbody) {
                tbody.innerHTML = '';
                
                changes.forEach(change => {
                    const row = tbody.insertRow();
                    
                    // Position
                    const positionCell = row.insertCell();
                    positionCell.textContent = change.position;
                    
                    // Current Officer
                    const currentCell = row.insertCell();
                    currentCell.textContent = change.currentOfficer;
                    
                    // New Officer
                    const newOfficerCell = row.insertCell();
                    newOfficerCell.textContent = change.newOfficerName;
                    
                    // Start Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = change.startDateFormatted;
                });
            }
            
            // Hide main content, show review
            Utils.hideElement('officer-content');
            Utils.showElement('officer-review');
            Utils.resizeIframe();
        }

        function backToOfficers() {
            Utils.hideElement('officer-review');
            Utils.showElement('officer-content');
            Utils.resizeIframe();
        }
        
        async function getContactInfo() {
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}&contact_info=true`;
            }
            
            await API.makeApiCall(endpoint, 'contactResult');
        }
        
        // CONTACT INFORMATION FUNCTIONALITY
        async function loadContactInfo() {
            console.log('=== loadContactInfo() started ===');
            console.log('Chapter:', appState.chapter);
            
            if (!appState.chapter) {
                Utils.showContactError('No chapter specified. Please access this page with a chapter parameter.');
                console.error('No chapter parameter found');
                return;
            }

            // Show loading state
            console.log('Showing loading state...');
            Utils.showLoading('contact-loading');
            Utils.hideElement('contact-content');
            Utils.hideElement('contact-error');

            try {
                // Build and execute query (doesn't need QUID, just chapter name)
                const queryRequest = Queries.buildChapterContactQuery(appState.chapter);
                const resultsData = await API.executeQuery(queryRequest, 'chapter_contact');
                
                // Process results
                const contactInfo = processContactResults(resultsData);
                console.log('Processed contact info:', contactInfo);
                
                // Display contact info
                displayContactInfo(contactInfo);
                
            } catch (error) {
                console.error('Error loading contact info:', error);
                Utils.showContactError(`Failed to load contact information: ${error.message}`);
            }
        }

        function processContactResults(results) {
            console.log('=== processContactResults() started ===');
            console.log('Raw results:', results);
            
            let contactInfo = {
                id: '',
                name: '',
                postalAddress1: '',
                postalAddress2: '',
                postalCity: '',
                postalState: '',
                postalZip: '',
                postalImpId: '',
                shippingAddress1: '',
                shippingAddress2: '',
                shippingCity: '',
                shippingState: '',
                shippingZip: '',
                shippingImpId: '',
                phone: '',
                email: ''
            };
            
            if (Array.isArray(results) && results.length > 0) {
                const row = results[0]; // Should only be one result
                console.log('Contact data:', row);
                
                contactInfo = {
                    id: row.ID || '',
                    name: row.Name || '',
                    postalAddress1: row.Postal_Address_Line_1 || '',
                    postalAddress2: row.Postal_Address_Line_2 || '',
                    postalCity: row.Postal_City || '',
                    postalState: row.Postal_State || '',
                    postalZip: row.Postal_ZIP || '',
                    postalImpId: row.Postal_ImpID || '',
                    shippingAddress1: row.Shipping_Address_Line_1 || '',
                    shippingAddress2: row.Shipping_Address_Line_2 || '',
                    shippingCity: row.Shipping_City || '',
                    shippingState: row.Shipping_State || '',
                    shippingZip: row.Shipping_ZIP || '',
                    shippingImpId: row.Shipping_ImpID || '',
                    phone: row.Phone || '',
                    email: row.Email || ''
                };
            } else {
                console.warn('No contact information found');
            }

            console.log('Processed contact info:', contactInfo);
            return contactInfo;
        }

        function displayContactInfo(contactInfo) {
            console.log('=== displayContactInfo() started ===');
            console.log('Contact info to display:', contactInfo);
            
            const chapterSpan = document.getElementById('contact-chapter');
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            
            // Store IDs for later use
            appState.contactId = contactInfo.id;
            appState.postalImpId = contactInfo.postalImpId;
            appState.shippingImpId = contactInfo.shippingImpId;
            
            // Populate form fields
            document.getElementById('postal-address-1').value = contactInfo.postalAddress1;
            document.getElementById('postal-address-2').value = contactInfo.postalAddress2;
            document.getElementById('postal-city').value = contactInfo.postalCity;
            document.getElementById('postal-state').value = contactInfo.postalState;
            document.getElementById('postal-zip').value = contactInfo.postalZip;
            
            document.getElementById('shipping-address-1').value = contactInfo.shippingAddress1;
            document.getElementById('shipping-address-2').value = contactInfo.shippingAddress2;
            document.getElementById('shipping-city').value = contactInfo.shippingCity;
            document.getElementById('shipping-state').value = contactInfo.shippingState;
            document.getElementById('shipping-zip').value = contactInfo.shippingZip;
            
            const phoneInput = document.getElementById('chapter-phone');
            const emailInput = document.getElementById('chapter-email');
            
            phoneInput.value = contactInfo.phone;
            emailInput.value = contactInfo.email;
            
            // Add phone formatting on input
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';
                
                if (value.length > 0) {
                    if (value.length <= 3) {
                        formattedValue = `(${value}`;
                    } else if (value.length <= 6) {
                        formattedValue = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                    } else {
                        formattedValue = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
                    }
                }
                
                e.target.value = formattedValue;
            });
            
            // Add email validation
            emailInput.addEventListener('blur', function(e) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (e.target.value && !emailRegex.test(e.target.value)) {
                    e.target.setCustomValidity('Please enter a valid email address');
                    e.target.reportValidity();
                } else {
                    e.target.setCustomValidity('');
                }
            });
            
            // Show content
            console.log('Hiding loading state and showing content...');
            Utils.hideElement('contact-loading');
            Utils.showElement('contact-content');
            
            // Trigger resize
            Utils.resizeIframe();
            console.log('=== displayContactInfo() completed ===');
        }

        function submitContactChanges() {
            // Validate email
            const emailInput = document.getElementById('chapter-email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailInput.value && !emailRegex.test(emailInput.value)) {
                Utils.showStatus('Please enter a valid email address.', 'error');
                emailInput.focus();
                return;
            }
            
            // Validate phone format
            const phoneInput = document.getElementById('chapter-phone');
            const phoneRegex = /^\(\d{3}\) \d{3}-\d{4}$/;
            if (phoneInput.value && !phoneRegex.test(phoneInput.value)) {
                Utils.showStatus('Please enter phone in format: (123) 456-7890', 'error');
                phoneInput.focus();
                return;
            }
            
            // Collect all contact data
            const contactData = {
                id: appState.contactId,
                postalAddress: {
                    impId: appState.postalImpId,
                    address1: document.getElementById('postal-address-1').value,
                    address2: document.getElementById('postal-address-2').value,
                    city: document.getElementById('postal-city').value,
                    state: document.getElementById('postal-state').value,
                    zip: document.getElementById('postal-zip').value
                },
                shippingAddress: {
                    impId: appState.shippingImpId,
                    address1: document.getElementById('shipping-address-1').value,
                    address2: document.getElementById('shipping-address-2').value,
                    city: document.getElementById('shipping-city').value,
                    state: document.getElementById('shipping-state').value,
                    zip: document.getElementById('shipping-zip').value
                },
                phone: document.getElementById('chapter-phone').value,
                email: document.getElementById('chapter-email').value
            };
            
            // For now, just show what would be submitted
            console.log('Contact information to submit:', contactData);
            Utils.showStatus('Ready to submit contact information updates. (Submit functionality coming soon)', 'info');
        }
        
        async function getFeeStatus() {
            const memberId = document.getElementById('memberId').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = memberId ? `/constituents/${memberId}/fees` : '/fees';
            
            if (appState.chapter && !memberId) {
                endpoint += `?chapter=${appState.chapter}`;
            }
            
            await API.makeApiCall(endpoint, 'feeResult');
        }
        
        // FEE STATUS FUNCTIONALITY
        async function loadFeeStatus() {
            console.log('=== loadFeeStatus() started ===');
            console.log('Chapter:', appState.chapter);
            
            if (!appState.chapter) {
                Utils.showFeeError('No chapter specified. Please access this page with a chapter parameter.');
                console.error('No chapter parameter found');
                return;
            }

            // Show loading state
            console.log('Showing loading state...');
            Utils.showLoading('fee-loading');
            Utils.hideElement('fee-content');
            Utils.hideElement('fee-error');

            try {
                // Get chapter QUID
                console.log('Getting chapter QUID for:', appState.chapter);
                const chapterQuid = await API.getChapterQuid(appState.chapter);
                console.log('Chapter QUID retrieved:', chapterQuid);
                
                if (!chapterQuid) {
                    throw new Error(`Chapter QUID not found for ${appState.chapter}`);
                }

                // Reuse roster query
                const queryRequest = Queries.buildRosterQuery(chapterQuid, appState.chapter);
                const resultsData = await API.executeQuery(queryRequest, 'fee_status');
                
                // Process results (same as roster)
                const feeData = processRosterResults(resultsData);
                console.log('Processed fee data:', feeData);
                
                // Display fee status
                displayFeeStatus(feeData);
                
            } catch (error) {
                console.error('Error loading fee status:', error);
                Utils.showFeeError(`Failed to load fee status: ${error.message}`);
            }
        }

        function displayFeeStatus(feeData) {
            console.log('=== displayFeeStatus() started ===');
            console.log('Number of members to display:', feeData.length);
            
            const chapterSpan = document.getElementById('fee-chapter');
            const tbody = document.getElementById('fee-tbody');
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            
            // Clear existing rows
            if (tbody) {
                tbody.innerHTML = '';
                
                if (feeData.length === 0) {
                    console.log('No members found - showing empty state');
                    const row = tbody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.className = 'empty-state-cell';
                    cell.textContent = 'No members found for this chapter.';
                } else {
                    console.log('Creating table rows for fee status...');
                    feeData.forEach((member, index) => {
                        console.log(`Creating row ${index} for:`, member);
                        
                        const row = tbody.insertRow();
                        
                        // Name
                        const nameCell = row.insertCell();
                        nameCell.textContent = member.name || 'N/A';
                        
                        // Current Status
                        const statusCell = row.insertCell();
                        statusCell.textContent = member.status === '5707' || member.status === 'Candidate' ? 'Candidate' : 
                                               member.status === '5708' || member.status === 'Initiate' ? 'Initiate' : 
                                               member.status;
                        
                        // Candidate Fee Paid
                        const candidateFeeCell = row.insertCell();
                        candidateFeeCell.textContent = member.candidateFeePaid || 'No';
                        if (member.candidateFeePaid === 'Yes') {
                            candidateFeeCell.style.color = '#28a745';
                            candidateFeeCell.style.fontWeight = 'bold';
                        } else {
                            candidateFeeCell.style.color = '#dc3545';
                        }
                        
                        // Initiate Fee Paid
                        const initiateFeeCell = row.insertCell();
                        initiateFeeCell.textContent = member.initiateFeePaid || 'No';
                        if (member.initiateFeePaid === 'Yes') {
                            initiateFeeCell.style.color = '#28a745';
                            initiateFeeCell.style.fontWeight = 'bold';
                        } else {
                            initiateFeeCell.style.color = '#dc3545';
                        }
                    });
                }
            }
            
            // Show content
            console.log('Hiding loading state and showing content...');
            Utils.hideElement('fee-loading');
            Utils.showElement('fee-content');
            
            // Trigger resize
            Utils.resizeIframe();
            console.log('=== displayFeeStatus() completed ===');
        }

        // INITIATES REVIEW FUNCTIONS
        function reviewInitiateChanges() {
            // Get all initiate changes
            const changes = [];
            const tbody = document.getElementById('initiates-tbody');
            
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach((row, index) => {
                    const initiateId = row.dataset.initiateId;
                    if (initiateId) {
                        const checkbox = document.getElementById(`initiated-${index}`);
                        const dateInput = document.getElementById(`initiate-ceremony-date-${index}`);
                        const badgeInput = document.getElementById(`badge-number-${index}`);
                        const nameCell = row.cells[1]; // Name is in second column
                        
                        if (checkbox && checkbox.checked && dateInput && badgeInput) {
                            changes.push({
                                id: initiateId,
                                code: row.dataset.code,
                                codeId: row.dataset.codeId,
                                relationId: row.dataset.relationId,
                                name: nameCell.textContent,
                                initiated: true,
                                ceremonyDate: dateInput.value,
                                ceremonyDateFormatted: dateInput.value ? Utils.formatDateForDisplay(dateInput.value) : '',
                                badgeNumber: badgeInput.value
                            });
                        }
                    }
                });
            }
            
            if (changes.length === 0) {
                const message = 'No initiates have been selected. Please check at least one initiate.';
                alert(message);
                Utils.showStatus(message, 'error');
                return;
            }
            
            // Validate that all selected initiates have ceremony dates and badge numbers
            const incomplete = changes.filter(i => !i.ceremonyDate || !i.badgeNumber);
            
            if (incomplete.length > 0) {
                const message = `Please ensure all selected initiates have ceremony dates and badge numbers. ${incomplete.length} initiate(s) missing required information.`;
                alert(message);
                Utils.showStatus(message, 'error');
                return;
            }
            
            // Validate badge numbers are greater than last badge
            if (appState.lastBadgeNumber !== null) {
                const invalidBadges = changes.filter(i => {
                    const badgeNum = parseInt(i.badgeNumber, 10);
                    return badgeNum <= appState.lastBadgeNumber;
                });
                
                if (invalidBadges.length > 0) {
                    const message = `Badge numbers must be greater than ${appState.lastBadgeNumber}. ${invalidBadges.length} initiate(s) have invalid badge numbers.`;
                    alert(message);
                    Utils.showStatus(message, 'error');
                    return;
                }
            }
            
            // Check for duplicate badge numbers
            const badgeNumbers = changes.map(c => parseInt(c.badgeNumber, 10));
            const uniqueBadgeNumbers = [...new Set(badgeNumbers)];
            
            if (badgeNumbers.length !== uniqueBadgeNumbers.length) {
                // Find the duplicate badge numbers
                const duplicates = badgeNumbers.filter((num, index) => badgeNumbers.indexOf(num) !== index);
                const uniqueDuplicates = [...new Set(duplicates)];
                const message = `Duplicate badge numbers found: ${uniqueDuplicates.join(', ')}. Each initiate must have a unique badge number.`;
                alert(message);
                Utils.showStatus(message, 'error');
                return;
            }
            
            // Only check for skipped numbers if validation is NOT disabled for this chapter
            if (!appState.skipValidationDisabled) {
                // Sort badge numbers and check for skipped numbers
                const sortedBadgeNumbers = [...badgeNumbers].sort((a, b) => a - b);
                const startingNumber = appState.lastBadgeNumber !== null ? appState.lastBadgeNumber : 0;
                
                // Check for skipped numbers from last badge to first new badge
                if (sortedBadgeNumbers[0] > startingNumber + 1) {
                    const skippedCount = sortedBadgeNumbers[0] - startingNumber - 1;
                    const skippedNumbers = [];
                    for (let i = startingNumber + 1; i < sortedBadgeNumbers[0]; i++) {
                        skippedNumbers.push(i);
                    }
                    const message = `Badge numbers must be consecutive. Skipped number(s): ${skippedNumbers.join(', ')} (${skippedCount} total) between ${startingNumber} and ${sortedBadgeNumbers[0]}.`;
                    alert(message);
                    Utils.showStatus(message, 'error');
                    return;
                }
                
                // Check for skipped numbers between new badges
                for (let i = 1; i < sortedBadgeNumbers.length; i++) {
                    if (sortedBadgeNumbers[i] > sortedBadgeNumbers[i-1] + 1) {
                        const skippedCount = sortedBadgeNumbers[i] - sortedBadgeNumbers[i-1] - 1;
                        const skippedNumbers = [];
                        for (let j = sortedBadgeNumbers[i-1] + 1; j < sortedBadgeNumbers[i]; j++) {
                            skippedNumbers.push(j);
                        }
                        const message = `Badge numbers must be consecutive. Skipped number(s): ${skippedNumbers.join(', ')} (${skippedCount} total) between ${sortedBadgeNumbers[i-1]} and ${sortedBadgeNumbers[i]}.`;
                        alert(message);
                        Utils.showStatus(message, 'error');
                        return;
                    }
                }
            } else {
                console.log('Skip validation is disabled for this chapter');
            }
            
            // Sort changes by badge number for display
            changes.sort((a, b) => parseInt(a.badgeNumber, 10) - parseInt(b.badgeNumber, 10));
            
            // Display review table
            displayInitiateReview(changes);
        }

        function displayInitiateReview(changes) {
            const chapterSpan = document.getElementById('initiates-review-chapter');
            const countSpan = document.getElementById('initiates-review-count');
            const tbody = document.getElementById('initiates-review-tbody');
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            if (countSpan) countSpan.textContent = changes.length;
            
            if (tbody) {
                tbody.innerHTML = '';
                
                changes.forEach(change => {
                    const row = tbody.insertRow();
                    
                    // Store the initiate data on the row for later retrieval
                    row.initiateData = {
                        id: change.id,
                        code: change.code,
                        codeId: change.codeId,
                        relationId: change.relationId
                    };
                    
                    // Name
                    const nameCell = row.insertCell();
                    nameCell.textContent = change.name;
                    
                    // Ceremony Date
                    const dateCell = row.insertCell();
                    dateCell.textContent = change.ceremonyDateFormatted;
                    
                    // Badge Number
                    const badgeCell = row.insertCell();
                    badgeCell.textContent = change.badgeNumber;
                });
            }
            
            // Hide main content, show review
            Utils.hideElement('initiates-content');
            Utils.showElement('initiates-review');
            Utils.resizeIframe();
        }

        function backToInitiates() {
            Utils.hideElement('initiates-review');
            Utils.showElement('initiates-content');
            Utils.resizeIframe();
        }

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            Main.init();
        });
    </script>
</body>
</html>