<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SN Chapter Management</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- UNAUTHORIZED ACCESS MESSAGE -->
        <div id="unauthorized" class="unauthorized" style="display: none;">
            <h2>Unauthorized Access</h2>
            <p>You do not have permission to access this application.</p>
            <p>Please contact your administrator for access.</p>
        </div>

        <!-- MAIN MENU (Visible by default) -->
        <div id="main-menu" class="main-menu">
            <h2>Chapter Management</h2>
            <div class="nav-buttons">
                <button class="nav-btn" id="btn-verify-candidates" onclick="showPage('verify-candidates')">Verify Candidates</button>
                <button class="nav-btn" id="btn-verify-initiates" onclick="showPage('verify-initiates')">Verify Initiates</button>
                <button class="nav-btn" id="btn-roster-info" onclick="showPage('roster-info')">Roster Information</button>
                <button class="nav-btn" id="btn-officer-info" onclick="showPage('officer-info')">Officer Information</button>
                <button class="nav-btn" id="btn-contact-info" onclick="showPage('contact-info')">Chapter Contact Information</button>
                <button class="nav-btn" id="btn-fee-status" onclick="showPage('fee-status')">Fee Status</button>
                <button class="nav-btn" id="btn-admin" onclick="showPage('admin')">Admin</button>
            </div>
        </div>

        <!-- VERIFY CANDIDATES PAGE -->
        <div id="verify-candidates" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Verify Candidates</h2>
            
            <div class="loading-message" id="candidates-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading prospective candidates...</p>
            </div>
            
            <div id="candidates-content" style="display: none;">
                <div class="candidates-info">
                    <p><strong>Chapter:</strong> <span id="candidates-chapter">-</span></p>
                    <p><strong>Total Candidates:</strong> <span id="candidates-count">0</span></p>
                </div>
                
                <div class="candidates-table-container">
                    <table class="candidates-table" id="candidates-table">
                        <thead>
                            <tr>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Candidate Ceremony Date</th>
                                <th>Approve</th>
                            </tr>
                        </thead>
                        <tbody id="candidates-tbody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="submit-section">
                    <button class="btn" onclick="submitCandidateVerifications()">Submit Verifications</button>
                </div>
            </div>
            
            <div id="candidates-error" class="error-message" style="display: none;">
                <p>Error loading candidates. Please try again or check your authentication.</p>
                <button class="btn" onclick="loadCandidates()">Retry</button>
            </div>
        </div>

        <!-- VERIFY INITIATES PAGE -->
        <div id="verify-initiates" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Verify Initiates</h2>
            <div class="form-group">
                <label for="initiateId">Initiate ID:</label>
                <input type="text" id="initiateId" placeholder="Enter initiate ID">
            </div>
            <button class="btn" onclick="verifyInitiate()">Verify Initiate</button>
            <div id="initiateResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- ROSTER INFORMATION PAGE -->
        <div id="roster-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Roster Information</h2>
            <div class="form-group">
                <label for="rosterType">Roster Type:</label>
                <select id="rosterType">
                    <option value="active">Active Members</option>
                    <option value="alumni">Alumni</option>
                    <option value="officers">Officers</option>
                    <option value="all">All Members</option>
                </select>
            </div>
            <button class="btn" onclick="getRosterInfo()">Get Roster Information</button>
            <div id="rosterResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- OFFICER INFORMATION PAGE -->
        <div id="officer-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Officer Information</h2>
            <div class="form-group">
                <label for="officerPosition">Officer Position:</label>
                <select id="officerPosition">
                    <option value="all">All Officers</option>
                    <option value="president">President</option>
                    <option value="vice-president">Vice President</option>
                    <option value="secretary">Secretary</option>
                    <option value="treasurer">Treasurer</option>
                </select>
            </div>
            <button class="btn" onclick="getOfficerInfo()">Get Officer Information</button>
            <div id="officerResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- CHAPTER CONTACT INFORMATION PAGE -->
        <div id="contact-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Chapter Contact Information</h2>
            <button class="btn" onclick="getContactInfo()">Get Chapter Contact Information</button>
            <div id="contactResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- FEE STATUS PAGE -->
        <div id="fee-status" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Fee Status</h2>
            <div class="form-group">
                <label for="memberId">Member ID (optional):</label>
                <input type="text" id="memberId" placeholder="Enter member ID or leave blank for all">
            </div>
            <button class="btn" onclick="getFeeStatus()">Get Fee Status</button>
            <div id="feeResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- ADMIN PAGE -->
        <div id="admin" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Admin & Testing</h2>
            
            <!-- Chapter Information Display -->
            <div class="url-params">
                <h3>Chapter Information</h3>
                <p><strong>SID:</strong> <span id="sid">Not provided</span></p>
                <p><strong>Chapter:</strong> <span id="chapter">Not provided</span></p>
            </div>
            
            <!-- Configuration Form -->
            <div class="config-section">
                <h3>API Configuration</h3>
                
                <div class="form-group">
                    <label for="clientId">Client ID:</label>
                    <input type="text" id="clientId" placeholder="Enter your Blackbaud Client ID">
                </div>
                
                <div class="form-group">
                    <label for="clientSecret">Client Secret:</label>
                    <input type="password" id="clientSecret" placeholder="Enter your Blackbaud Client Secret">
                </div>
                
                <div class="form-group">
                    <label for="subscriptionKey">Subscription Key:</label>
                    <input type="password" id="subscriptionKey" placeholder="Enter your SKY API Subscription Key">
                </div>
                
                <button class="btn" onclick="authenticate()">Authenticate & Get Token</button>
                
                <div id="status" class="status"></div>
                
                <div id="tokenInfo" class="token-info" style="display: none;">
                    <h3>Token Information</h3>
                    <p><strong>Access Token:</strong> <span id="accessToken">***</span></p>
                    <p><strong>Token Type:</strong> <span id="tokenType">Bearer</span></p>
                    <p><strong>Expires At:</strong> <span id="expiresAt">-</span></p>
                    <p><strong>Status:</strong> <span id="tokenStatus">Active</span></p>
                </div>
            </div>

            <!-- API Testing Form -->
            <div class="testing-section">
                <h3>API Testing</h3>
                <div class="form-group">
                    <label for="apiEndpoint">API Endpoint:</label>
                    <select id="apiEndpoint">
                        <option value="/constituents">Constituents</option>
                        <option value="/gifts">Gifts</option>
                        <option value="/funds">Funds</option>
                        <option value="/appeals">Appeals</option>
                        <option value="/campaigns">Campaigns</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="customEndpoint">Custom Endpoint (optional):</label>
                    <input type="text" id="customEndpoint" placeholder="e.g., /constituents/123">
                </div>
                
                <button class="btn" onclick="testApiCall()">Test API Call</button>
                
                <div id="apiResponse" class="response-area" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            tokenEndpoint: 'https://oauth2.sky.blackbaud.com/token',
            apiBaseUrl: 'https://api.sky.blackbaud.com/',
            tokenRefreshBuffer: 300000 // 5 minutes in milliseconds
        }

        // CANDIDATES FUNCTIONALITY
        async function loadCandidates() {
            console.log('=== loadCandidates() started ===');
            console.log('Chapter:', appState.chapter);
            
            if (!appState.chapter) {
                showError('candidates-error', 'No chapter specified. Please access this page with a chapter parameter.');
                console.error('No chapter parameter found');
                return;
            }

            // Show loading state
            console.log('Showing loading state...');
            showLoading('candidates-loading');
            hideElement('candidates-content');
            hideElement('candidates-error');

            try {
                // Execute ad-hoc query to get candidates
                console.log('Executing candidates query...');
                const candidates = await executeCandidatesQuery();
                console.log('Candidates received:', candidates);
                
                // Display candidates
                displayCandidates(candidates);
                
            } catch (error) {
                console.error('Error loading candidates:', error);
                showError('candidates-error', `Failed to load candidates: ${error.message}`);
            }
        }

        async function executeCandidatesQuery() {
            console.log('=== executeCandidatesQuery() started ===');
            
            // Get chapter QUID from chapter lookup
            console.log('Getting chapter QUID for:', appState.chapter);
            const chapterQuid = await getChapterQuid(appState.chapter);
            console.log('Chapter QUID retrieved:', chapterQuid);
            
            if (!chapterQuid) {
                throw new Error(`Chapter QUID not found for ${appState.chapter}`);
            }

            // Build query request with QUID
            const queryRequest = {
                "query": {
                    "advanced_processing_options": {
                        "use_alternate_sql_code_table_fields": false,
                        "use_alternate_sql_multiple_attributes": false
                    },
                    "constituent_filters": {
                        "include_deceased": false,
                        "include_inactive": true,
                        "include_no_valid_addresses": true
                    },
                    "filter_fields": [
                        {
                            "compare_type": "None",
                            "filter_values": ["6985"],
                            "left_parenthesis": false,
                            "operator": "Equals",
                            "query_field_id": 2217,
                            "right_parenthesis": false
                        },
                        {
                            "compare_type": "And",
                            "filter_values": [String(chapterQuid)], // Convert QUID to string
                            "operator": "Equals",
                            "query_field_id": 656,
                            "unique_id": "120"
                        }
                    ],
                    "gift_processing_options": {
                        "matching_gift_credit_option": "MatchingGiftCompany",
                        "soft_credit_option": "Donor",
                        "use_gross_amount_for_covenants": false
                    },
                    "select_fields": [
                        {
                            "query_field_id": 349,
                            "user_alias": "ID"
                        },
                        {
                            "query_field_id": 597
                        }
                    ],
                    "sort_fields": [
                        {
                            "query_field_id": 597,
                            "sort_order": "Ascending"
                        }
                    ],
                    "suppress_duplicates": true,
                    "type_id": 18,
                    "sql_generation_mode": "Query"
                },
                "ux_mode": "Synchronous",
                "output_format": "Json",
                "formatting_mode": "UI",
                "results_file_name": "prospective_candidates",
                "time_zone_offset_in_minutes": 120
            };

            console.log('Query request built:', JSON.stringify(queryRequest, null, 2));

            // Step 1: Execute the query (no token needed - server handles it)
            console.log('Executing query via API...');
            const executeResponse = await fetch(`/api/blackbaud?action=query-execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(queryRequest)
            });

            console.log('Execute response status:', executeResponse.status);

            if (!executeResponse.ok) {
                const errorText = await executeResponse.text();
                console.error('Execute response error:', errorText);
                throw new Error(`Query execution failed: ${executeResponse.status} - ${errorText}`);
            }

            const executeData = await executeResponse.json();
            console.log('Execute response data:', executeData);
            
            // Get the job ID from the response - check different possible field names
            const jobId = executeData.id || executeData.job_id || executeData.jobId;
            if (!jobId) {
                console.error('No job ID found in response:', executeData);
                throw new Error('No job ID returned from query execution');
            }

            console.log('Query job ID:', jobId);

            // Step 2: Poll for job completion
            let attempts = 0;
            const maxAttempts = 60; // 60 seconds timeout
            let resultsUrl = null;
            
            while (attempts < maxAttempts) {
                console.log(`Polling attempt ${attempts + 1}/${maxAttempts}...`);
                
                const statusResponse = await fetch(`/api/blackbaud?action=query-status&jobId=${jobId}`, {
                    method: 'GET'
                });

                if (!statusResponse.ok) {
                    const errorText = await statusResponse.text();
                    console.error('Status check error:', errorText);
                    throw new Error(`Query status check failed: ${statusResponse.status}`);
                }

                const statusData = await statusResponse.json();
                console.log('Status data:', statusData);

                // Check for completion - API might use different field names
                const status = statusData.status || statusData.state;
                console.log('Job status:', status);

                if (status === 'completed' || status === 'Completed' || status === 'COMPLETED' || status === 'succeeded') {
                    // Get the results URL - check various possible field names
                    resultsUrl = statusData.url || statusData.result_url || statusData.read_url || statusData.results_url;
                    
                    // Sometimes the URL might be in a nested object
                    if (!resultsUrl && statusData.result) {
                        resultsUrl = statusData.result.url || statusData.result.read_url;
                    }
                    
                    if (resultsUrl) {
                        console.log('Query completed - results URL:', resultsUrl);
                        break;
                    } else {
                        console.warn('Job completed but no results URL found:', statusData);
                    }
                } else if (status === 'failed' || status === 'Failed' || status === 'FAILED' || status === 'error') {
                    throw new Error('Query execution failed: ' + (statusData.message || statusData.error || 'Unknown error'));
                }

                // Wait 1 second before next attempt
                await new Promise(resolve => setTimeout(resolve, 1000));
                attempts++;
            }

            if (!resultsUrl) {
                throw new Error('Query execution timeout or no results URL provided');
            }

            // Step 3: Fetch the actual results
            console.log('Fetching query results from URL...');
            const resultsResponse = await fetch(`/api/blackbaud?action=query-results&url=${encodeURIComponent(resultsUrl)}`, {
                method: 'GET'
            });

            if (!resultsResponse.ok) {
                throw new Error(`Failed to fetch query results: ${resultsResponse.status}`);
            }

            const resultsData = await resultsResponse.json();
            console.log('Query results received:', resultsData);
            
            return processQueryResults(resultsData);
        }

        function processQueryResults(results) {
            console.log('=== processQueryResults() started ===');
            console.log('Raw results:', results);
            
            const candidates = [];
            
            // Handle the JSON format from the query results file
            if (Array.isArray(results)) {
                console.log(`Processing ${results.length} candidates`);
                
                results.forEach((row, index) => {
                    console.log(`Row ${index}:`, row);
                    
                    const candidate = {
                        id: row.ID || row.QRECID || row.id,
                        name: row.Name || row.name || 'N/A'
                    };
                    
                    console.log(`Candidate ${index}:`, candidate);
                    candidates.push(candidate);
                });
            } else if (results && results.rows && Array.isArray(results.rows)) {
                // Handle alternative format if the API returns it differently
                console.log(`Processing ${results.rows.length} rows (alternative format)`);
                
                results.rows.forEach((row, index) => {
                    if (row.values && row.values.length >= 2) {
                        const candidate = {
                            id: row.values[0],
                            name: row.values[1] || 'N/A'
                        };
                        console.log(`Candidate ${index}:`, candidate);
                        candidates.push(candidate);
                    }
                });
            } else {
                console.warn('Unexpected results format:', results);
            }

            console.log(`Total candidates processed: ${candidates.length}`);
            return candidates;
        }

        async function getChapterQuid(chapterName) {
            console.log('=== getChapterQuid() started ===');
            console.log('Looking up QUID for chapter:', chapterName);
            
            // First, try to get from server-side lookup
            try {
                const response = await fetch(`/api/blackbaud?action=chapter-lookup&chapter=${encodeURIComponent(chapterName)}`, {
                    method: 'GET'
                });
                
                console.log('Chapter lookup response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Chapter data received:', data);
                    return data.quid;
                }
            } catch (error) {
                console.warn('Server-side chapter lookup failed:', error);
            }

            // Fallback - this would need to be populated from your chapter-records.js
            console.error('Chapter QUID not found');
            return null;
        }

        function filterCandidatesByChapter(constituents) {
            if (!Array.isArray(constituents)) {
                console.warn('Expected array of constituents, got:', constituents);
                return [];
            }

            return constituents.filter(constituent => {
                // Look for "Preferred Chapter Name" custom field
                if (constituent.custom_fields && Array.isArray(constituent.custom_fields)) {
                    const preferredChapterField = constituent.custom_fields.find(field => 
                        field.name === 'Preferred Chapter Name' || 
                        field.category === 'Preferred Chapter Name'
                    );
                    
                    if (preferredChapterField) {
                        const fieldValue = preferredChapterField.text_value || preferredChapterField.value || '';
                        return fieldValue.toLowerCase() === appState.chapter.toLowerCase();
                    }
                }
                
                return false; // Only include constituents with matching Preferred Chapter Name field
            });
        }

        function displayCandidates(candidates) {
            console.log('=== displayCandidates() started ===');
            console.log('Number of candidates to display:', candidates.length);
            
            const chapterSpan = document.getElementById('candidates-chapter');
            const countSpan = document.getElementById('candidates-count');
            const tbody = document.getElementById('candidates-tbody');
            
            if (chapterSpan) chapterSpan.textContent = appState.chapter || 'Unknown';
            if (countSpan) countSpan.textContent = candidates.length;
            
            // Clear existing rows
            if (tbody) {
                tbody.innerHTML = '';
                
                if (candidates.length === 0) {
                    console.log('No candidates found - showing empty state');
                    const row = tbody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 3; // Updated colspan for 3 columns
                    cell.className = 'empty-state-cell';
                    cell.textContent = 'No prospective candidates found for this chapter.';
                } else {
                    console.log('Creating table rows for candidates...');
                    candidates.forEach((candidate, index) => {
                        console.log(`Creating row ${index} for:`, candidate);
                        
                        const row = tbody.insertRow();
                        
                        // Store candidate ID as data attribute
                        row.dataset.candidateId = candidate.id;
                        
                        // Name (single column)
                        const nameCell = row.insertCell();
                        nameCell.textContent = candidate.name || 'N/A';
                        
                        // Approve dropdown
                        const approveCell = row.insertCell();
                        const approveSelect = document.createElement('select');
                        approveSelect.className = 'approval-select';
                        approveSelect.id = `approval-${index}`;
                        
                        // No Change option (default, blank value)
                        const noChangeOption = document.createElement('option');
                        noChangeOption.value = '';
                        noChangeOption.textContent = 'No Change';
                        noChangeOption.selected = true;
                        approveSelect.appendChild(noChangeOption);
                        
                        const approveOption = document.createElement('option');
                        approveOption.value = 'approve';
                        approveOption.textContent = 'Approve';
                        approveSelect.appendChild(approveOption);
                        
                        const disapproveOption = document.createElement('option');
                        disapproveOption.value = 'disapprove';
                        disapproveOption.textContent = 'Disapprove';
                        approveSelect.appendChild(disapproveOption);
                        
                        const unknownOption = document.createElement('option');
                        unknownOption.value = 'unknown';
                        unknownOption.textContent = 'Unknown (Remove)';
                        approveSelect.appendChild(unknownOption);
                        
                        // Add change event listener
                        approveSelect.addEventListener('change', function() {
                            handleApprovalChange(index, this.value);
                        });
                        
                        approveCell.appendChild(approveSelect);
                        
                        // Candidate Ceremony Date
                        const dateCell = row.insertCell();
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.className = 'date-input';
                        dateInput.id = `ceremony-date-${index}`;
                        dateInput.disabled = true; // Initially disabled
                        
                        // Set max date to today
                        const today = new Date();
                        dateInput.max = today.toISOString().split('T')[0];
                        
                        dateCell.appendChild(dateInput);
                    });
                }
            }
            
            // Show content
            console.log('Hiding loading state and showing content...');
            hideElement('candidates-loading');
            showElement('candidates-content');
            
            // Trigger resize
            resizeIframe();
            console.log('=== displayCandidates() completed ===');
        }

        function handleApprovalChange(index, approvalValue) {
            const dateInput = document.getElementById(`ceremony-date-${index}`);
            if (!dateInput) return;

            if (approvalValue === 'approve') {
                // Enable date picker for approved candidates
                dateInput.disabled = false;
                dateInput.value = ''; // Clear any default value
            } else if (approvalValue === '' || !approvalValue) {
                // No Change selected - disable and clear date
                dateInput.disabled = true;
                dateInput.value = '';
            } else {
                // Disapprove or Unknown - disable date picker and set to today's date in Eastern Time
                dateInput.disabled = true;
                
                // Get today's date in Eastern Time
                const easternTime = new Date().toLocaleString("en-US", {timeZone: "America/New_York"});
                const easternDate = new Date(easternTime);
                
                // Format as YYYY-MM-DD for input field
                const year = easternDate.getFullYear();
                const month = String(easternDate.getMonth() + 1).padStart(2, '0');
                const day = String(easternDate.getDate()).padStart(2, '0');
                
                dateInput.value = `${year}-${month}-${day}`;
            }
        }

        function submitCandidateVerifications() {
            // Get all candidate data
            const candidates = [];
            const tbody = document.getElementById('candidates-tbody');
            
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach((row, index) => {
                    const candidateId = row.dataset.candidateId;
                    if (candidateId) {
                        const approvalSelect = document.getElementById(`approval-${index}`);
                        const dateInput = document.getElementById(`ceremony-date-${index}`);
                        
                        if (approvalSelect && dateInput) {
                            // Only include candidates where a change was made (not "No Change")
                            if (approvalSelect.value !== '') {
                                // Format date as mm/dd/yyyy for display
                                let formattedDate = '';
                                if (dateInput.value) {
                                    const [year, month, day] = dateInput.value.split('-');
                                    formattedDate = `${month}/${day}/${year}`;
                                }
                                
                                candidates.push({
                                    id: candidateId,
                                    approval: approvalSelect.value,
                                    ceremonyDate: dateInput.value,
                                    ceremonyDateFormatted: formattedDate
                                });
                            }
                        }
                    }
                });
            }
            
            if (candidates.length === 0) {
                showStatus('No changes have been made. Please select approval status for at least one candidate.', 'error');
                return;
            }
            
            // Validate that all changed candidates have ceremony dates
            const incomplete = candidates.filter(c => !c.ceremonyDate);
            
            if (incomplete.length > 0) {
                showStatus(`Please ensure all candidates have ceremony dates. ${incomplete.length} candidate(s) missing ceremony date.`, 'error');
                return;
            }
            
            // For now, just show what would be submitted
            console.log('Candidate verifications to submit:', candidates);
            showStatus(`Ready to submit ${candidates.length} candidate verification(s). (Submit functionality coming soon)`, 'info');
        }

        // UTILITY FUNCTIONS
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'block';
        }

        function hideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'none';
        }

        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'block';
        }

        function showError(elementId, message) {
            hideElement('candidates-loading');
            hideElement('candidates-content');
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                const errorText = errorElement.querySelector('p');
                if (errorText) errorText.textContent = message;
                errorElement.style.display = 'block';
            }
        };

        // Application state
        let appState = {
            accessToken: null,
            tokenType: 'Bearer',
            expiresAt: null,
            refreshTimer: null,
            clientId: null,
            clientSecret: null,
            subscriptionKey: null,
            sid: null,
            chapter: null,
            sts: null,
            currentPage: 'main'
        };

        // SIMPLE NAVIGATION FUNCTIONS
        function showPage(pageId) {
            // Check authorization before showing any page
            if (!isAuthorized()) {
                return;
            }
            
            // Hide main menu
            document.getElementById('main-menu').style.display = 'none';
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show selected page
            document.getElementById(pageId).style.display = 'block';
            appState.currentPage = pageId;
            
            // Load page-specific data
            if (pageId === 'verify-candidates') {
                loadCandidates();
            }
            
            // Notify parent of height change
            resizeIframe();
        }

        function showMainMenu() {
            // Check authorization
            if (!isAuthorized()) {
                return;
            }
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show main menu
            document.getElementById('main-menu').style.display = 'block';
            appState.currentPage = 'main';
            
            // Notify parent of height change
            resizeIframe();
        }

        // Authorization check function
        function isAuthorized() {
            return appState.sts !== null && ['0', '1', '2'].includes(appState.sts);
        }

        // Apply security level based on sts parameter
        function applySecurityLevel() {
            const mainMenu = document.getElementById('main-menu');
            const unauthorized = document.getElementById('unauthorized');
            
            // If no sts parameter or invalid value, show unauthorized
            if (appState.sts === null || !['0', '1', '2'].includes(appState.sts)) {
                mainMenu.style.display = 'none';
                unauthorized.style.display = 'block';
                
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.style.display = 'none';
                });
                
                resizeIframe();
                return;
            }
            
            // Show main menu
            unauthorized.style.display = 'none';
            mainMenu.style.display = 'block';
            
            // Hide all buttons first
            const buttons = {
                'btn-verify-candidates': false,
                'btn-verify-initiates': false,
                'btn-roster-info': false,
                'btn-officer-info': false,
                'btn-contact-info': false,
                'btn-fee-status': false,
                'btn-admin': false
            };
            
            // Show buttons based on sts value
            switch(appState.sts) {
                case '0': // Show all buttons including Admin
                    Object.keys(buttons).forEach(btn => buttons[btn] = true);
                    break;
                case '1': // Show all buttons except Admin
                    Object.keys(buttons).forEach(btn => {
                        buttons[btn] = btn !== 'btn-admin';
                    });
                    break;
                case '2': // Show only Fee Status (Treasurer) button
                    buttons['btn-fee-status'] = true;
                    break;
            }
            
            // Apply visibility
            Object.keys(buttons).forEach(btnId => {
                const button = document.getElementById(btnId);
                if (button) {
                    button.style.display = buttons[btnId] ? 'block' : 'none';
                }
            });
            
            resizeIframe();
        }

        // Function to communicate height to parent iframe
        function resizeIframe() {
            // Wait for DOM to settle, then force recalculation
            setTimeout(() => {
                // Force the body to shrink to its content
                document.body.style.height = 'auto';
                
                // Force a reflow
                document.body.offsetHeight;
                
                // Get the actual content height
                const container = document.querySelector('.container');
                const containerHeight = container ? container.offsetHeight : 0;
                const bodyPadding = 40; // 20px top + 20px bottom
                const totalHeight = containerHeight + bodyPadding;
                
                // Send height to parent window
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'resize',
                        height: totalHeight
                    }, '*');
                }
            }, 150);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            parseURLParameters();
            loadStoredCredentials();
            checkTokenStatus();
            
            // Initial iframe resize
            resizeIframe();
        });

        function parseURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const sid = urlParams.get('sid') || urlParams.get('SID') || 'Not provided';
            const chapter = urlParams.get('chapter') || urlParams.get('Chapter') || 'Not provided';
            const sts = urlParams.get('sts') || urlParams.get('STS');
            
            // Store in application state
            appState.sid = sid !== 'Not provided' ? sid : null;
            appState.chapter = chapter !== 'Not provided' ? chapter : null;
            appState.sts = sts;
            
            const sidElement = document.getElementById('sid');
            const chapterElement = document.getElementById('chapter');
            if (sidElement) sidElement.textContent = sid;
            if (chapterElement) chapterElement.textContent = chapter;
            
            // Apply security based on sts parameter
            applySecurityLevel();
        }

        function loadStoredCredentials() {
            // In a real application, you'd load these from secure server-side storage
            // For demo purposes, we'll use the form inputs
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function updateTokenInfo() {
            const tokenInfo = document.getElementById('tokenInfo');
            const accessTokenSpan = document.getElementById('accessToken');
            const tokenTypeSpan = document.getElementById('tokenType');
            const expiresAtSpan = document.getElementById('expiresAt');
            const tokenStatusSpan = document.getElementById('tokenStatus');
            
            if (appState.accessToken && tokenInfo) {
                tokenInfo.style.display = 'block';
                if (accessTokenSpan) accessTokenSpan.textContent = appState.accessToken.substring(0, 20) + '...';
                if (tokenTypeSpan) tokenTypeSpan.textContent = appState.tokenType;
                if (expiresAtSpan) expiresAtSpan.textContent = appState.expiresAt ? new Date(appState.expiresAt).toLocaleString() : 'Unknown';
                if (tokenStatusSpan) tokenStatusSpan.textContent = isTokenValid() ? 'Active' : 'Expired';
            } else if (tokenInfo) {
                tokenInfo.style.display = 'none';
            }
        }

        function isTokenValid() {
            console.log('Checking token validity...');
            console.log('Access Token exists:', !!appState.accessToken);
            console.log('Expires At:', appState.expiresAt);
            console.log('Current Time:', new Date().getTime());
            console.log('Time until expiration:', appState.expiresAt ? (appState.expiresAt - new Date().getTime()) / 1000 + ' seconds' : 'N/A');
            
            const valid = appState.accessToken && appState.expiresAt && new Date().getTime() < appState.expiresAt;
            console.log('Token is valid:', valid);
            return valid;
        }

        async function authenticate() {
            showStatus('Authenticating with server...', 'info');
            
            try {
                const response = await fetch('/api/blackbaud?action=auth', {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`Authentication failed: ${response.status}`);
                }
                
                const tokenData = await response.json();
                
                // Store token information
                appState.accessToken = tokenData.access_token;
                appState.tokenType = tokenData.token_type || 'Bearer';
                appState.expiresAt = new Date().getTime() + (tokenData.expires_in * 1000);
                
                // Schedule token refresh
                scheduleTokenRefresh(tokenData.expires_in);
                
                updateTokenInfo();
                showStatus('Authentication successful!', 'success');
                
            } catch (error) {
                console.error('Authentication error:', error);
                showStatus(`Authentication failed: ${error.message}`, 'error');
            }
        }

        function scheduleTokenRefresh(expiresInSeconds) {
            // Clear existing timer
            if (appState.refreshTimer) {
                clearTimeout(appState.refreshTimer);
            }
            
            // Schedule refresh 5 minutes before expiration
            const refreshTime = (expiresInSeconds * 1000) - CONFIG.tokenRefreshBuffer;
            
            appState.refreshTimer = setTimeout(() => {
                refreshToken();
            }, refreshTime);
        }

        async function refreshToken() {
            if (!appState.clientId || !appState.clientSecret) {
                showStatus('Missing credentials for token refresh', 'error');
                return;
            }
            
            try {
                const response = await fetch(CONFIG.tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Basic ${btoa(appState.clientId + ':' + appState.clientSecret)}`
                    },
                    body: 'grant_type=client_credentials'
                });
                
                if (!response.ok) {
                    throw new Error(`Token refresh failed: ${response.status}`);
                }
                
                const tokenData = await response.json();
                
                appState.accessToken = tokenData.access_token;
                appState.expiresAt = new Date().getTime() + (tokenData.expires_in * 1000);
                
                scheduleTokenRefresh(tokenData.expires_in);
                updateTokenInfo();
                
                console.log('Token refreshed successfully');
                
            } catch (error) {
                console.error('Token refresh error:', error);
                showStatus('Token refresh failed. Please re-authenticate.', 'error');
            }
        }

        function checkTokenStatus() {
            // Check token validity every minute
            setInterval(() => {
                updateTokenInfo();
            }, 60000);
        }

        async function makeApiCall(endpoint, resultElementId) {
            if (!isTokenValid()) {
                showStatus('No valid token. Please authenticate first.', 'error');
                return;
            }
            
            const responseArea = document.getElementById(resultElementId);
            if (responseArea) {
                responseArea.style.display = 'block';
                responseArea.textContent = 'Making API call...';
            }
            
            try {
                // Add SID and Chapter to endpoint if available
                let fullEndpoint = endpoint;
                if (appState.sid && endpoint.includes('{sid}')) {
                    fullEndpoint = fullEndpoint.replace('{sid}', appState.sid);
                }
                if (appState.chapter && endpoint.includes('{chapter}')) {
                    fullEndpoint = fullEndpoint.replace('{chapter}', appState.chapter);
                }
                
                const response = await fetch(`/api/blackbaud?action=api&endpoint=${encodeURIComponent(fullEndpoint)}&token=${appState.accessToken}`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                
                const data = await response.json();
                if (responseArea) {
                    responseArea.textContent = JSON.stringify(data, null, 2);
                }
                showStatus('API call successful!', 'success');
                
            } catch (error) {
                console.error('API call error:', error);
                if (responseArea) {
                    responseArea.textContent = `Error: ${error.message}`;
                }
                showStatus(`API call failed: ${error.message}`, 'error');
            }
        }
        
        // Page-specific functions
        async function verifyCandidate() {
            const candidateId = document.getElementById('candidateId').value;
            if (!candidateId) {
                showStatus('Please enter a candidate ID.', 'error');
                return;
            }
            
            const endpoint = `/constituents/${candidateId}`;
            await makeApiCall(endpoint, 'candidateResult');
        }
        
        async function verifyInitiate() {
            const initiateId = document.getElementById('initiateId').value;
            if (!initiateId) {
                showStatus('Please enter an initiate ID.', 'error');
                return;
            }
            
            const endpoint = `/constituents/${initiateId}`;
            await makeApiCall(endpoint, 'initiateResult');
        }
        
        async function getRosterInfo() {
            const rosterType = document.getElementById('rosterType').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            // Add filtering based on roster type and chapter info
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}`;
            }
            
            await makeApiCall(endpoint, 'rosterResult');
        }
        
        async function getOfficerInfo() {
            const officerPosition = document.getElementById('officerPosition').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            // Add filtering for officers
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}&role=officer`;
            }
            
            await makeApiCall(endpoint, 'officerResult');
        }
        
        async function getContactInfo() {
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}&contact_info=true`;
            }
            
            await makeApiCall(endpoint, 'contactResult');
        }
        
        async function getFeeStatus() {
            const memberId = document.getElementById('memberId').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = memberId ? `/constituents/${memberId}/fees` : '/fees';
            
            if (appState.chapter && !memberId) {
                endpoint += `?chapter=${appState.chapter}`;
            }
            
            await makeApiCall(endpoint, 'feeResult');
        }

        // Admin/Testing function
        async function testApiCall() {
            if (!isTokenValid()) {
                showStatus('No valid token. Please authenticate first.', 'error');
                return;
            }
            
            const endpoint = document.getElementById('customEndpoint').value || 
                           document.getElementById('apiEndpoint').value;
            
            const responseArea = document.getElementById('apiResponse');
            if (responseArea) {
                responseArea.style.display = 'block';
                responseArea.textContent = 'Making API call...';
            }
            
            try {
                // Add SID and Chapter to endpoint if available
                let fullEndpoint = endpoint;
                if (appState.sid && endpoint.includes('{sid}')) {
                    fullEndpoint = fullEndpoint.replace('{sid}', appState.sid);
                }
                if (appState.chapter && endpoint.includes('{chapter}')) {
                    fullEndpoint = fullEndpoint.replace('{chapter}', appState.chapter);
                }
                
                const response = await fetch(`/api/blackbaud?action=api&endpoint=${encodeURIComponent(fullEndpoint)}&token=${appState.accessToken}`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                
                const data = await response.json();
                if (responseArea) {
                    responseArea.textContent = JSON.stringify(data, null, 2);
                }
                showStatus('Test API call successful!', 'success');
                
            } catch (error) {
                console.error('API call error:', error);
                if (responseArea) {
                    responseArea.textContent = `Error: ${error.message}`;
                }
                showStatus(`Test API call failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>