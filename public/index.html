<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SN Chapter Management</title>
    <link rel="stylesheet" href="https://sn-chapter-management.vercel.app/styles.css">
</head>
<body>
    <div class="container">
        <!-- MAIN MENU (Visible by default) -->
        <div id="main-menu" class="main-menu">
            <h2>Chapter Management</h2>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showPage('verify-candidates')">Verify Candidates</button>
                <button class="nav-btn" onclick="showPage('verify-initiates')">Verify Initiates</button>
                <button class="nav-btn" onclick="showPage('roster-info')">Roster Information</button>
                <button class="nav-btn" onclick="showPage('officer-info')">Officer Information</button>
                <button class="nav-btn" onclick="showPage('contact-info')">Chapter Contact Information</button>
                <button class="nav-btn" onclick="showPage('fee-status')">Fee Status</button>
                <button class="nav-btn" onclick="showPage('admin')">Admin</button>
            </div>
        </div>

        <!-- VERIFY CANDIDATES PAGE -->
        <div id="verify-candidates" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Verify Candidates</h2>
            <div class="form-group">
                <label for="candidateId">Candidate ID:</label>
                <input type="text" id="candidateId" placeholder="Enter candidate ID">
            </div>
            <button class="btn" onclick="verifyCandidate()">Verify Candidate</button>
            <div id="candidateResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- VERIFY INITIATES PAGE -->
        <div id="verify-initiates" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Verify Initiates</h2>
            <div class="form-group">
                <label for="initiateId">Initiate ID:</label>
                <input type="text" id="initiateId" placeholder="Enter initiate ID">
            </div>
            <button class="btn" onclick="verifyInitiate()">Verify Initiate</button>
            <div id="initiateResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- ROSTER INFORMATION PAGE -->
        <div id="roster-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Roster Information</h2>
            <div class="form-group">
                <label for="rosterType">Roster Type:</label>
                <select id="rosterType">
                    <option value="active">Active Members</option>
                    <option value="alumni">Alumni</option>
                    <option value="officers">Officers</option>
                    <option value="all">All Members</option>
                </select>
            </div>
            <button class="btn" onclick="getRosterInfo()">Get Roster Information</button>
            <div id="rosterResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- OFFICER INFORMATION PAGE -->
        <div id="officer-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Officer Information</h2>
            <div class="form-group">
                <label for="officerPosition">Officer Position:</label>
                <select id="officerPosition">
                    <option value="all">All Officers</option>
                    <option value="president">President</option>
                    <option value="vice-president">Vice President</option>
                    <option value="secretary">Secretary</option>
                    <option value="treasurer">Treasurer</option>
                </select>
            </div>
            <button class="btn" onclick="getOfficerInfo()">Get Officer Information</button>
            <div id="officerResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- CHAPTER CONTACT INFORMATION PAGE -->
        <div id="contact-info" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Chapter Contact Information</h2>
            <button class="btn" onclick="getContactInfo()">Get Chapter Contact Information</button>
            <div id="contactResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- FEE STATUS PAGE -->
        <div id="fee-status" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Fee Status</h2>
            <div class="form-group">
                <label for="memberId">Member ID (optional):</label>
                <input type="text" id="memberId" placeholder="Enter member ID or leave blank for all">
            </div>
            <button class="btn" onclick="getFeeStatus()">Get Fee Status</button>
            <div id="feeResult" class="response-area" style="display: none;"></div>
        </div>

        <!-- ADMIN PAGE -->
        <div id="admin" class="page">
            <button class="back-btn" onclick="showMainMenu()">← Back to Main Menu</button>
            <h2>Admin & Testing</h2>
            
            <!-- Chapter Information Display -->
            <div class="url-params">
                <h3>Chapter Information</h3>
                <p><strong>SID:</strong> <span id="sid">Not provided</span></p>
                <p><strong>Chapter:</strong> <span id="chapter">Not provided</span></p>
            </div>
            
            <!-- Configuration Form -->
            <div class="config-section">
                <h3>API Configuration</h3>
                
                <div class="form-group">
                    <label for="clientId">Client ID:</label>
                    <input type="text" id="clientId" placeholder="Enter your Blackbaud Client ID">
                </div>
                
                <div class="form-group">
                    <label for="clientSecret">Client Secret:</label>
                    <input type="password" id="clientSecret" placeholder="Enter your Blackbaud Client Secret">
                </div>
                
                <div class="form-group">
                    <label for="subscriptionKey">Subscription Key:</label>
                    <input type="password" id="subscriptionKey" placeholder="Enter your SKY API Subscription Key">
                </div>
                
                <button class="btn" onclick="authenticate()">Authenticate & Get Token</button>
                
                <div id="status" class="status"></div>
                
                <div id="tokenInfo" class="token-info" style="display: none;">
                    <h3>Token Information</h3>
                    <p><strong>Access Token:</strong> <span id="accessToken">***</span></p>
                    <p><strong>Token Type:</strong> <span id="tokenType">Bearer</span></p>
                    <p><strong>Expires At:</strong> <span id="expiresAt">-</span></p>
                    <p><strong>Status:</strong> <span id="tokenStatus">Active</span></p>
                </div>
            </div>

            <!-- API Testing Form -->
            <div class="testing-section">
                <h3>API Testing</h3>
                <div class="form-group">
                    <label for="apiEndpoint">API Endpoint:</label>
                    <select id="apiEndpoint">
                        <option value="/constituents">Constituents</option>
                        <option value="/gifts">Gifts</option>
                        <option value="/funds">Funds</option>
                        <option value="/appeals">Appeals</option>
                        <option value="/campaigns">Campaigns</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="customEndpoint">Custom Endpoint (optional):</label>
                    <input type="text" id="customEndpoint" placeholder="e.g., /constituents/123">
                </div>
                
                <button class="btn" onclick="testApiCall()">Test API Call</button>
                
                <div id="apiResponse" class="response-area" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            tokenEndpoint: 'https://oauth2.sky.blackbaud.com/token',
            apiBaseUrl: 'https://api.sky.blackbaud.com/',
            tokenRefreshBuffer: 300000 // 5 minutes in milliseconds
        };

        // Application state
        let appState = {
            accessToken: null,
            tokenType: 'Bearer',
            expiresAt: null,
            refreshTimer: null,
            clientId: null,
            clientSecret: null,
            subscriptionKey: null,
            sid: null,
            chapter: null,
            currentPage: 'main'
        };

        // SIMPLE NAVIGATION FUNCTIONS
        function showPage(pageId) {
            // Hide main menu
            document.getElementById('main-menu').style.display = 'none';
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show selected page
            document.getElementById(pageId).style.display = 'block';
            appState.currentPage = pageId;
        }

        function showMainMenu() {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // Show main menu
            document.getElementById('main-menu').style.display = 'block';
            appState.currentPage = 'main';
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            parseURLParameters();
            loadStoredCredentials();
            checkTokenStatus();
        });

        function parseURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const sid = urlParams.get('sid') || urlParams.get('SID') || 'Not provided';
            const chapter = urlParams.get('chapter') || urlParams.get('Chapter') || 'Not provided';
            
            // Store in application state
            appState.sid = sid !== 'Not provided' ? sid : null;
            appState.chapter = chapter !== 'Not provided' ? chapter : null;
            
            const sidElement = document.getElementById('sid');
            const chapterElement = document.getElementById('chapter');
            if (sidElement) sidElement.textContent = sid;
            if (chapterElement) chapterElement.textContent = chapter;
        }

        function loadStoredCredentials() {
            // In a real application, you'd load these from secure server-side storage
            // For demo purposes, we'll use the form inputs
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function updateTokenInfo() {
            const tokenInfo = document.getElementById('tokenInfo');
            const accessTokenSpan = document.getElementById('accessToken');
            const tokenTypeSpan = document.getElementById('tokenType');
            const expiresAtSpan = document.getElementById('expiresAt');
            const tokenStatusSpan = document.getElementById('tokenStatus');
            
            if (appState.accessToken && tokenInfo) {
                tokenInfo.style.display = 'block';
                if (accessTokenSpan) accessTokenSpan.textContent = appState.accessToken.substring(0, 20) + '...';
                if (tokenTypeSpan) tokenTypeSpan.textContent = appState.tokenType;
                if (expiresAtSpan) expiresAtSpan.textContent = appState.expiresAt ? new Date(appState.expiresAt).toLocaleString() : 'Unknown';
                if (tokenStatusSpan) tokenStatusSpan.textContent = isTokenValid() ? 'Active' : 'Expired';
            } else if (tokenInfo) {
                tokenInfo.style.display = 'none';
            }
        }

        function isTokenValid() {
            return appState.accessToken && appState.expiresAt && new Date().getTime() < appState.expiresAt;
        }

        async function authenticate() {
            showStatus('Authenticating with server...', 'info');
            
            try {
                const response = await fetch('/api/blackbaud?action=auth', {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`Authentication failed: ${response.status}`);
                }
                
                const tokenData = await response.json();
                
                // Store token information
                appState.accessToken = tokenData.access_token;
                appState.tokenType = tokenData.token_type || 'Bearer';
                appState.expiresAt = new Date().getTime() + (tokenData.expires_in * 1000);
                
                // Schedule token refresh
                scheduleTokenRefresh(tokenData.expires_in);
                
                updateTokenInfo();
                showStatus('Authentication successful!', 'success');
                
            } catch (error) {
                console.error('Authentication error:', error);
                showStatus(`Authentication failed: ${error.message}`, 'error');
            }
        }

        function scheduleTokenRefresh(expiresInSeconds) {
            // Clear existing timer
            if (appState.refreshTimer) {
                clearTimeout(appState.refreshTimer);
            }
            
            // Schedule refresh 5 minutes before expiration
            const refreshTime = (expiresInSeconds * 1000) - CONFIG.tokenRefreshBuffer;
            
            appState.refreshTimer = setTimeout(() => {
                refreshToken();
            }, refreshTime);
        }

        async function refreshToken() {
            if (!appState.clientId || !appState.clientSecret) {
                showStatus('Missing credentials for token refresh', 'error');
                return;
            }
            
            try {
                const response = await fetch(CONFIG.tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Basic ${btoa(appState.clientId + ':' + appState.clientSecret)}`
                    },
                    body: 'grant_type=client_credentials'
                });
                
                if (!response.ok) {
                    throw new Error(`Token refresh failed: ${response.status}`);
                }
                
                const tokenData = await response.json();
                
                appState.accessToken = tokenData.access_token;
                appState.expiresAt = new Date().getTime() + (tokenData.expires_in * 1000);
                
                scheduleTokenRefresh(tokenData.expires_in);
                updateTokenInfo();
                
                console.log('Token refreshed successfully');
                
            } catch (error) {
                console.error('Token refresh error:', error);
                showStatus('Token refresh failed. Please re-authenticate.', 'error');
            }
        }

        function checkTokenStatus() {
            // Check token validity every minute
            setInterval(() => {
                updateTokenInfo();
            }, 60000);
        }

        async function makeApiCall(endpoint, resultElementId) {
            if (!isTokenValid()) {
                showStatus('No valid token. Please authenticate first.', 'error');
                return;
            }
            
            const responseArea = document.getElementById(resultElementId);
            if (responseArea) {
                responseArea.style.display = 'block';
                responseArea.textContent = 'Making API call...';
            }
            
            try {
                // Add SID and Chapter to endpoint if available
                let fullEndpoint = endpoint;
                if (appState.sid && endpoint.includes('{sid}')) {
                    fullEndpoint = fullEndpoint.replace('{sid}', appState.sid);
                }
                if (appState.chapter && endpoint.includes('{chapter}')) {
                    fullEndpoint = fullEndpoint.replace('{chapter}', appState.chapter);
                }
                
                const response = await fetch(`/api/blackbaud?action=api&endpoint=${encodeURIComponent(fullEndpoint)}&token=${appState.accessToken}`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                
                const data = await response.json();
                if (responseArea) {
                    responseArea.textContent = JSON.stringify(data, null, 2);
                }
                showStatus('API call successful!', 'success');
                
            } catch (error) {
                console.error('API call error:', error);
                if (responseArea) {
                    responseArea.textContent = `Error: ${error.message}`;
                }
                showStatus(`API call failed: ${error.message}`, 'error');
            }
        }
        
        // Page-specific functions
        async function verifyCandidate() {
            const candidateId = document.getElementById('candidateId').value;
            if (!candidateId) {
                showStatus('Please enter a candidate ID.', 'error');
                return;
            }
            
            const endpoint = `/constituents/${candidateId}`;
            await makeApiCall(endpoint, 'candidateResult');
        }
        
        async function verifyInitiate() {
            const initiateId = document.getElementById('initiateId').value;
            if (!initiateId) {
                showStatus('Please enter an initiate ID.', 'error');
                return;
            }
            
            const endpoint = `/constituents/${initiateId}`;
            await makeApiCall(endpoint, 'initiateResult');
        }
        
        async function getRosterInfo() {
            const rosterType = document.getElementById('rosterType').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            // Add filtering based on roster type and chapter info
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}`;
            }
            
            await makeApiCall(endpoint, 'rosterResult');
        }
        
        async function getOfficerInfo() {
            const officerPosition = document.getElementById('officerPosition').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            // Add filtering for officers
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}&role=officer`;
            }
            
            await makeApiCall(endpoint, 'officerResult');
        }
        
        async function getContactInfo() {
            // This would need to be customized based on your specific API structure
            let endpoint = '/constituents';
            
            if (appState.chapter) {
                endpoint += `?chapter=${appState.chapter}&contact_info=true`;
            }
            
            await makeApiCall(endpoint, 'contactResult');
        }
        
        async function getFeeStatus() {
            const memberId = document.getElementById('memberId').value;
            
            // This would need to be customized based on your specific API structure
            let endpoint = memberId ? `/constituents/${memberId}/fees` : '/fees';
            
            if (appState.chapter && !memberId) {
                endpoint += `?chapter=${appState.chapter}`;
            }
            
            await makeApiCall(endpoint, 'feeResult');
        }

        // Admin/Testing function
        async function testApiCall() {
            if (!isTokenValid()) {
                showStatus('No valid token. Please authenticate first.', 'error');
                return;
            }
            
            const endpoint = document.getElementById('customEndpoint').value || 
                           document.getElementById('apiEndpoint').value;
            
            const responseArea = document.getElementById('apiResponse');
            if (responseArea) {
                responseArea.style.display = 'block';
                responseArea.textContent = 'Making API call...';
            }
            
            try {
                // Add SID and Chapter to endpoint if available
                let fullEndpoint = endpoint;
                if (appState.sid && endpoint.includes('{sid}')) {
                    fullEndpoint = fullEndpoint.replace('{sid}', appState.sid);
                }
                if (appState.chapter && endpoint.includes('{chapter}')) {
                    fullEndpoint = fullEndpoint.replace('{chapter}', appState.chapter);
                }
                
                const response = await fetch(`/api/blackbaud?action=api&endpoint=${encodeURIComponent(fullEndpoint)}&token=${appState.accessToken}`, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                
                const data = await response.json();
                if (responseArea) {
                    responseArea.textContent = JSON.stringify(data, null, 2);
                }
                showStatus('Test API call successful!', 'success');
                
            } catch (error) {
                console.error('API call error:', error);
                if (responseArea) {
                    responseArea.textContent = `Error: ${error.message}`;
                }
                showStatus(`Test API call failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>